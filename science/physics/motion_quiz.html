<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Chapter Quiz</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'cbse-blue': '#1a3e6a',
                        'cbse-light': '#f0f4f8',
                        'accent-green': '#059669',
                        'correct': '#10b981', // Emerald 500
                        'incorrect': '#ef4444', // Red 500
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="../../js/config.js"></script>
</head>
<body class="bg-cbse-light min-h-screen antialiased">

    <header class="bg-white shadow-lg sticky top-0 z-10 border-t-8 border-cbse-blue">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl font-bold text-cbse-blue">Motion Chapter Quiz Portal</h1>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="quiz-container" class="container bg-white p-6 md:p-10 rounded-xl shadow-lg">
            <p class="text-cbse-blue font-semibold">Loading quiz modules...</p>
        </div>

        <div id="config-error" class="hidden error-message mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            Configuration Error ðŸ›‘<br>Quiz failed to load because Supabase credentials are missing or the 'config.js' file could not be found.
        </div>
    </main>

    <script>
        // ==================================================================================
        // QUIZ LOGIC (Batch Display and Submission)
        // ==================================================================================

        const TABLE_NAME = 'motion';
        const TARGET_QUESTION_COUNT = 20;

        let ALL_QUESTIONS = {}; // Stores questions segregated by difficulty
        let QUIZ_DATA = {}; // Stores the current quiz questions and user answers
        let quizDataLoaded = false; 

        // Utility: Sanitizes text (removes LaTeX math formatting)
        function cleanText(text) {
            if (!text) return '';
            let cleaned = text
                .replace(/\$\\(text)\{([^\}]+)\}\$|\\text\{([^\}]+)\}|(\\\$)|(\\\\)|(\text\{[^\}]+\})/g, (match, p1, p2, p3) => {
                    const matchText = match.match(/\\text\{([^\}]+)\}/);
                    if (matchText) return matchText[1];
                    if (match === '\\$') return 'â‚¹';
                    if (match === '\\\\') return '<br>';
                    return match;
                })
                .replace(/\$/g, '')
                .replace(/\\(left|right)[\(\)\|\{\}]/g, '');
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            return cleaned;
        }

        function shuffleAndSlice(array, count) {
            const shuffled = array.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // --- Supabase Connection and Initialization ---

        function initSupabase() {
            if (quizDataLoaded) { 
                renderDifficultySelection(null); 
                return;
            }
            const configError = document.getElementById('config-error');

            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined') {
                configError.classList.remove('hidden');
                document.getElementById('quiz-container').innerHTML = ''; 
            } else {
                const supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );

                fetchQuizData(supabaseClient);
            }
        }

        async function fetchQuizData(supabaseClient) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow-xl">Fetching Questions from Supabase...</div>`;

            const { data: quizData, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (error) {
                container.innerHTML = `<p class="error-message text-red-700 bg-red-100 p-4 rounded">Error retrieving questions: ${error.message}. Please check RLS policy for the table **${TABLE_NAME}**.</p>`;
                return;
            }

            if (quizData) {
                quizDataLoaded = true;
                // Separate questions by difficulty for the selection screen. Use 'complex' as the key.
                const simpleQuestions = quizData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'simple');
                const mediumQuestions = quizData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'medium');
                const complexQuestions = quizData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'complex');
                ALL_QUESTIONS = { simple: simpleQuestions, medium: mediumQuestions, complex: complexQuestions };
                
                renderDifficultySelection(quizData); 
            }
        }
        
        // --- Render Difficulty (Styled to match demand_quiz) ---

        function renderDifficultySelection(fullData) {
            const container = document.getElementById('quiz-container');

            if (Object.keys(ALL_QUESTIONS).length === 0 || 
                (ALL_QUESTIONS.simple?.length === 0 && ALL_QUESTIONS.medium?.length === 0 && ALL_QUESTIONS.complex?.length === 0)) {
                   container.innerHTML = `<p class="text-red-700 p-4 rounded bg-red-100">
                       **No Quiz Questions Found!** Please ensure your Supabase table **${TABLE_NAME}** contains questions.
                       </p>`;
                   return;
            }

            const html = `
                <h2 class="text-3xl font-extrabold text-cbse-blue mb-8">Choose Difficulty for Motion Chapter</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${createDifficultyCard('simple', ALL_QUESTIONS.simple?.length || 0, 'Easy start, covers foundational concepts.', 'bg-accent-green hover:bg-green-700')}
                    ${createDifficultyCard('medium', ALL_QUESTIONS.medium?.length || 0, 'Moderate difficulty, requires application of concepts.', 'bg-yellow-600 hover:bg-yellow-700')}
                    ${createDifficultyCard('complex', ALL_QUESTIONS.complex?.length || 0, 'High difficulty, includes numericals and critical analysis.', 'bg-red-600 hover:bg-red-700')}
                </div>
            `;
            container.innerHTML = html;
        }

        function createDifficultyCard(level, count, description, colorClass) {
            const actualCount = Math.min(count, TARGET_QUESTION_COUNT);
            const buttonText = count >= TARGET_QUESTION_COUNT ? `Start Quiz (${TARGET_QUESTION_COUNT} Qs)` : `Start Quiz (${actualCount} Qs)`;
            
            // This displays 'Advanced' for 'complex' in the selection card
            const displayName = level.charAt(0).toUpperCase() + level.slice(1);
            
            return `
                <div class="p-6 bg-cbse-light rounded-lg shadow-md border border-gray-200">
                    <h4 class="text-2xl font-bold capitalize text-cbse-blue mb-2">${displayName === 'Complex' ? 'Advanced' : displayName}</h4>
                    <p class="text-gray-600 text-sm mb-4">${description}</p>
                    <p class="text-sm font-semibold mb-4 text-gray-700">Available: ${count} questions. Starting: ${actualCount} questions.</p>
                    <button
                        class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition duration-150 ${colorClass}"
                        onclick="startQuiz('${level}')"
                        ${actualCount === 0 ? 'disabled' : ''}>
                        ${actualCount === 0 ? 'No Questions Available' : buttonText}
                    </button>
                </div>
            `;
        }
        
        // --- Start Quiz (Initializes QUIZ_DATA and renders all questions) ---
        function startQuiz(difficulty) {
            const allQs = ALL_QUESTIONS[difficulty];
            QUIZ_DATA.questions = shuffleAndSlice(allQs, TARGET_QUESTION_COUNT);
            QUIZ_DATA.difficulty = difficulty;
            QUIZ_DATA.answers = {}; // Initialize user answers object

            renderQuiz();
        }

        // --- Store Answer (Called by radio button onChange) ---
        function storeAnswer(qIndex, answerKey) {
            QUIZ_DATA.answers[qIndex] = answerKey;
        }


        // --- Render Quiz (Displays ALL questions at once) ---
        function renderQuiz() {
            const container = document.getElementById('quiz-container');

            // ðŸŒŸ FIX APPLIED HERE: Correctly display 'Advanced' for the 'complex' difficulty
            const rawDifficulty = QUIZ_DATA.difficulty;
            let titleDifficulty;
            
            if (rawDifficulty === 'complex') {
                titleDifficulty = 'Advanced';
            } else {
                titleDifficulty = rawDifficulty.charAt(0).toUpperCase() + rawDifficulty.slice(1);
            }

            let quizHtml = `<h2 class="text-3xl font-extrabold text-cbse-blue mb-6">${titleDifficulty} Quiz (${QUIZ_DATA.questions.length} Questions)</h2>`;

            QUIZ_DATA.questions.forEach((q, index) => {
                const questionNumber = index + 1;
                const questionText = cleanText(q.question_text);
                const scenarioReasonText = cleanText(q.scenario_reason_text);
                const showScenario = scenarioReasonText && scenarioReasonText.toUpperCase() !== 'N/A';

                const options = [
                    { key: 'A', text: cleanText(q.option_a) },
                    { key: 'B', text: cleanText(q.option_b) },
                    { key: 'C', text: cleanText(q.option_c) },
                    { key: 'D', text: cleanText(q.option_d) }
                ].filter(opt => opt.text !== null && opt.text.trim() !== '');

                quizHtml += `
                    <div id="q-card-${index}" class="question-card p-6 mb-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <p class="text-lg font-semibold text-gray-800 mb-3">${questionNumber}. ${questionText}</p>

                        ${showScenario ?
                            `<p class="text-lg font-normal text-gray-700 mb-4 bg-gray-50 p-3 rounded">${scenarioReasonText}</p>`
                            : ''}

                        <div class="options space-y-2">
                            ${options.map(opt => `
                                <label class="block p-3 border border-gray-100 rounded-lg cursor-pointer hover:bg-cbse-light transition duration-150">
                                    <input
                                        type="radio"
                                        name="q_${index}"
                                        value="${opt.key}"
                                        onchange="storeAnswer(${index}, this.value)"
                                        class="mr-3 text-cbse-blue focus:ring-cbse-blue"
                                    >
                                    <span class="font-medium">${opt.key}.</span> ${opt.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            quizHtml += `
                <button
                    id="submit-button"
                    class="w-full mt-8 px-8 py-3 text-lg bg-cbse-blue text-white font-bold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150"
                    onclick="submitQuiz()">
                    Submit Answers
                </button>
                <button
                    class="w-full mt-4 text-sm text-gray-500 hover:text-cbse-blue transition duration-150"
                    onclick="window.location.reload()">
                    Restart Quiz
                </button>
            `;

            container.innerHTML = quizHtml;
        }

        
        // --- Submit Quiz (Scores all questions and displays answers) ---
        function submitQuiz() {
            // FIX: Declare totalQuestions once.
            const totalQuestions = QUIZ_DATA.questions.length;
            let score = 0;

            QUIZ_DATA.questions.forEach((q, index) => {
                const userAnswer = QUIZ_DATA.answers[index];
                const correctAnswer = q.correct_answer_key;
                const questionCard = document.getElementById(`q-card-${index}`);

                // Disable all inputs
                const radios = questionCard.querySelectorAll(`input[name="q_${index}"]`);
                radios.forEach(radio => radio.disabled = true);

                // Highlight card background
                if (userAnswer === correctAnswer) {
                    score++;
                    questionCard.classList.add('border-correct', 'bg-green-50', 'border-2');
                } else {
                    questionCard.classList.add('border-incorrect', 'bg-red-50', 'border-2');
                }

                // Highlight options
                const optionsContainer = questionCard.querySelector('.options');
                const options = optionsContainer.querySelectorAll('label');

                options.forEach(label => {
                    const input = label.querySelector('input');
                    const optionKey = input.value;

                    if (optionKey === correctAnswer) {
                        label.classList.add('bg-correct', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else if (optionKey === userAnswer && userAnswer !== correctAnswer) {
                        label.classList.add('bg-incorrect', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else if (optionKey !== correctAnswer && optionKey !== userAnswer) {
                        label.classList.add('opacity-50');
                    }
                });
            });

            const percentage = ((score / totalQuestions) * 100).toFixed(1);

            const scoreHtml = `
                <div class="p-6 md:p-10 mb-8 text-center bg-cbse-blue text-white rounded-lg shadow-2xl">
                    <h3 class="text-4xl font-extrabold mb-2">Quiz Complete!</h3>
                    <p class="text-6xl font-black">${score}/${totalQuestions}</p>
                    <p class="text-xl font-semibold mt-2">Your Score is: ${percentage}%</p>
                    <p class="mt-4 text-sm">Review your answers below (Green = Correct option, Red = Your incorrect selection).</p>
                </div>
            `;
            document.getElementById('quiz-container').insertAdjacentHTML('afterbegin', scoreHtml);
            document.getElementById('submit-button').remove();

            document.getElementById('quiz-container').scrollIntoView({ behavior: 'smooth' });
        }


        // ==================================================================================
        // DOM LOAD LISTENER (Directly initialize Supabase)
        // ==================================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('quiz-container');
            // Initial loading message
            container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow-xl">Loading Quiz Data...</div>`;
            
            // Start the quiz process immediately
            initSupabase(); 
        });
        
        // Expose functions to the global scope for use in inline HTML attributes (onclick, onchange)
        window.startQuiz = startQuiz;
        window.storeAnswer = storeAnswer;
        window.submitQuiz = submitQuiz;
    </script>
</body>
</html>
