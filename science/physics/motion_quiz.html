<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Chapter Quiz</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'cbse-blue': '#1a3e6a',
                        'cbse-light': '#f0f4f8',
                        'accent-green': '#059669',
                        'correct': '#10b981',
                        'incorrect': '#ef4444',
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script src="../../js/config.js"></script>
</head>
<body class="bg-cbse-light min-h-screen antialiased">

    <header class="bg-white shadow-lg sticky top-0 z-10 border-t-8 border-cbse-blue">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl font-bold text-cbse-blue">Motion Chapter Quiz Portal</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="quiz-container" class="container bg-white p-6 md:p-10 rounded-xl shadow-lg">
            <p class="text-cbse-blue font-semibold">Loading quiz modules...</p>
        </div>

        <div id="config-error" class="hidden error-message mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            Configuration Error ðŸ›‘<br>Quiz failed to load because Supabase credentials are missing or the 'config.js' file could not be found.
        </div>
    </main>

    <div id="auth-modal" class="modal-overlay hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 50;">
        <div id="auth-view" class="bg-white relative p-8 rounded-lg shadow-xl" style="max-width: 400px;">
            <h2 class="text-2xl font-bold text-center mb-6 text-cbse-blue">Login to Access Quizzes</h2>
            <div class="mt-4">
                <button id="google-sign-in-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center space-x-3 shadow-md">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_google_g_standard.png" alt="Google logo" class="w-6 h-6 bg-white rounded-full">
                    <span>Sign in with Google</span>
                </button>
            </div>
            <p id="error-message" class="mt-4 text-center text-red-500 font-medium"></p>
        </div>
    </div>


    <script>
        // ==================================================================================
        // FIREBASE INITIALIZATION AND LOGGING FUNCTION
        // ==================================================================================
        
        // Configuration from economics (1).html
        const firebaseConfig = {
            apiKey: "AIzaSyAXdKiYRxBKAj280YcNuNwlKKDp85xpOWQ",
            authDomain: "quiz-signon.firebaseapp.com",
            projectId: "quiz-signon",
            storageBucket: "quiz-signon.firebasestorage.app",
            messagingSenderId: "863414222321",
            appId: "1:863414222321:web:819f5564825308bcd9d850",
            measurementId: "G-4EFDM0CRYY"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        
        const authModal = document.getElementById('auth-modal');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const errorMessage = document.getElementById('error-message');

        googleSignInBtn.addEventListener('click', async () => {
             errorMessage.textContent = 'Signing in with Google...';
            googleSignInBtn.disabled = true;

            const provider = new firebase.auth.GoogleAuthProvider();

            try {
                // Set a flag before initiating sign-in
                localStorage.setItem('auth_in_progress', 'true'); 
                await auth.signInWithPopup(provider);
            } catch (error) {
                let displayMessage = 'Google Sign-in failed: ' + error.message;
                errorMessage.textContent = displayMessage;
            } finally {
                googleSignInBtn.disabled = false;
                localStorage.removeItem('auth_in_progress'); 
            }
        });

        function logFinalQuizScore(score, total, chapterName, difficulty) {
            const user = auth.currentUser;
            if (!user) return;

            db.collection("quiz_scores").add({
                userId: user.uid,
                email: user.email || 'N/A',
                chapter: chapterName,
                difficulty: difficulty,
                score: score,
                total: total,
                percentage: (score / total) * 100,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                action: 'Quiz Completed'
            });
        }

        // ==================================================================================
        // END FIREBASE SETUP
        // ==================================================================================

        // State variables
        let ALL_QUESTIONS = {};
        let QUIZ_DATA = {};
        const TARGET_QUESTION_COUNT = 20;
        const TABLE_NAME = 'motion';
        let quizDataLoaded = false; 

        function shuffleAndSlice(array, count) {
            const shuffled = array.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function cleanText(text) {
            if (!text) return '';

            let cleaned = text
                .replace(/\$\\(text)\{([^\}]+)\}\$|\\text\{([^\}]+)\}|(\\\$)|(\\\\)|(\text\{[^\}]+\})/g, (match, p1, p2, p3) => {
                    const matchText = match.match(/\\text\{([^\}]+)\}/);
                    if (matchText) return matchText[1];
                    if (match === '\\$') return 'â‚¹';
                    if (match === '\\\\') return '<br>';
                    return match;
                })
                .replace(/\$/g, '')
                .replace(/\\(left|right)[\(\)\|\{\}]/g, '');

            cleaned = cleaned.replace(/a\s+\*+['"]?([^*'"]+)['"]?\*+\s+in/, 'a <u>$1</u> in');
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            return cleaned;
        }

        function renderDifficultySelection(fullData) {
            
            if (Array.isArray(fullData) && fullData.length > 0 && !quizDataLoaded) {
                 const simpleQuestions = fullData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'simple');
                const mediumQuestions = fullData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'medium');
                const complexQuestions = fullData.filter(q => q.difficulty && q.difficulty.toLowerCase() === 'complex');

                ALL_QUESTIONS = {
                    simple: simpleQuestions,
                    medium: mediumQuestions,
                    complex: complexQuestions
                };
            }
            
            const container = document.getElementById('quiz-container');

            if (Object.keys(ALL_QUESTIONS).length === 0 || 
                (ALL_QUESTIONS.simple?.length === 0 && ALL_QUESTIONS.medium?.length === 0 && ALL_QUESTIONS.complex?.length === 0)) {
                 container.innerHTML = `<p class="text-red-700 p-4 rounded bg-red-100">
                    **No Quiz Questions Found!** Please ensure your Supabase table **${TABLE_NAME}** contains questions and that the RLS (Row Level Security) policy permits **SELECT** access for your authenticated user.
                    </p>`;
                 return;
            }

            const html = `
                <h2 class="text-3xl font-extrabold text-cbse-blue mb-8">Choose Difficulty for Motion Chapter</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${createDifficultyCard('simple', ALL_QUESTIONS.simple?.length || 0, 'Easy start, covers foundational concepts.', 'bg-accent-green hover:bg-green-700')}
                    ${createDifficultyCard('medium', ALL_QUESTIONS.medium?.length || 0, 'Moderate difficulty, requires application of concepts.', 'bg-yellow-600 hover:bg-yellow-700')}
                    ${createDifficultyCard('complex', ALL_QUESTIONS.complex?.length || 0, 'High difficulty, includes numericals and critical analysis.', 'bg-red-600 hover:bg-red-700')}
                </div>
            `;
            container.innerHTML = html;
        }

        function createDifficultyCard(level, count, description, colorClass) {
            const actualCount = Math.min(count, TARGET_QUESTION_COUNT);
            const buttonText = count >= TARGET_QUESTION_COUNT
                ? `Start Quiz (${TARGET_QUESTION_COUNT} Qs)`
                : `Start Quiz (${actualCount} Qs)`;
            
            const displayName = level.charAt(0).toUpperCase() + level.slice(1);
            
            return `
                <div class="p-6 bg-cbse-light rounded-lg shadow-md border border-gray-200">
                    <h4 class="text-2xl font-bold capitalize text-cbse-blue mb-2">${displayName === 'Complex' ? 'Advanced' : displayName}</h4>
                    <p class="text-gray-600 text-sm mb-4">${description}</p>
                    <p class="text-sm font-semibold mb-4 text-gray-700">Available: ${count} questions. Starting: ${actualCount} questions.</p>
                    <button
                        class="px-6 py-2 text-white font-bold rounded-lg shadow-md transition duration-150 ${colorClass}"
                        onclick="startQuiz('${level}')"
                        ${actualCount === 0 ? 'disabled' : ''}>
                        ${actualCount === 0 ? 'No Questions Available' : buttonText}
                    </button>
                </div>
            `;
        }
        
        function startQuiz(difficulty) {
            const allQs = ALL_QUESTIONS[difficulty];
            QUIZ_DATA.questions = shuffleAndSlice(allQs, TARGET_QUESTION_COUNT);
            QUIZ_DATA.difficulty = difficulty;
            QUIZ_DATA.answers = {};

             if (auth.currentUser) {
                db.collection("quiz_attempts").add({
                    userId: auth.currentUser.uid,
                    email: auth.currentUser.email || 'N/A',
                    chapter: "7. Motion",
                    difficulty: difficulty,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    action: 'Quiz Attempted'
                });
            }

            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');

            const displayDifficulty = QUIZ_DATA.difficulty.charAt(0).toUpperCase() + QUIZ_DATA.difficulty.slice(1);
            const titleDifficulty = displayDifficulty === 'Complex' ? 'Advanced' : displayDifficulty;

            let quizHtml = `<h2 class="text-3xl font-extrabold text-cbse-blue mb-6">${titleDifficulty} Quiz (${QUIZ_DATA.questions.length} Questions)</h2>`;

            QUIZ_DATA.questions.forEach((q, index) => {
                const questionNumber = index + 1;
                const questionText = cleanText(q.question_text);
                const scenarioReasonText = cleanText(q.scenario_reason_text);
                const showScenario = scenarioReasonText && scenarioReasonText.toUpperCase() !== 'N/A';

                const options = [
                    { key: 'A', text: cleanText(q.option_a) },
                    { key: 'B', text: cleanText(q.option_b) },
                    { key: 'C', text: cleanText(q.option_c) },
                    { key: 'D', text: cleanText(q.option_d) }
                ].filter(opt => opt.text !== null && opt.text.trim() !== '');

                quizHtml += `
                    <div id="q-card-${index}" class="question-card p-6 mb-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <p class="text-lg font-semibold text-gray-800 mb-3">${questionNumber}. ${questionText}</p>

                        ${showScenario ?
                            `<p class="text-lg font-normal text-gray-700 mb-4 bg-gray-50 p-3 rounded">${scenarioReasonText}</p>`
                            : ''}

                        <div class="options space-y-2">
                            ${options.map(opt => `
                                <label class="block p-3 border border-gray-100 rounded-lg cursor-pointer hover:bg-cbse-light transition duration-150">
                                    <input
                                        type="radio"
                                        name="q_${index}"
                                        value="${opt.key}"
                                        onchange="storeAnswer(${index}, this.value)"
                                        class="mr-3 text-cbse-blue focus:ring-cbse-blue"
                                    >
                                    <span class="font-medium">${opt.key}.</span> ${opt.text}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            quizHtml += `
                <button
                    id="submit-button"
                    class="w-full mt-8 px-8 py-3 text-lg bg-cbse-blue text-white font-bold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150"
                    onclick="submitQuiz()">
                    Submit Answers
                </button>
                <button
                    class="w-full mt-4 text-sm text-gray-500 hover:text-cbse-blue transition duration-150"
                    onclick="window.location.reload()">
                    Restart Quiz
                </button>
            `;

            container.innerHTML = quizHtml;
        }

        function storeAnswer(qIndex, answerKey) {
            QUIZ_DATA.answers[qIndex] = answerKey;
        }
        
        function submitQuiz() {
            const totalQuestions = QUIZ_DATA.questions.length;
            let score = 0;

            QUIZ_DATA.questions.forEach((q, index) => {
                const userAnswer = QUIZ_DATA.answers[index];
                const correctAnswer = q.correct_answer_key;
                const questionCard = document.getElementById(`q-card-${index}`);

                const radios = questionCard.querySelectorAll(`input[name="q_${index}"]`);
                radios.forEach(radio => radio.disabled = true);

                if (userAnswer === correctAnswer) {
                    score++;
                    questionCard.classList.add('border-correct', 'bg-green-50');
                } else {
                    questionCard.classList.add('border-incorrect', 'bg-red-50');
                }

                const optionsContainer = questionCard.querySelector('.options');
                const options = optionsContainer.querySelectorAll('label');

                options.forEach(label => {
                    const input = label.querySelector('input');
                    const optionKey = input.value;

                    if (optionKey === correctAnswer) {
                        label.classList.add('bg-correct', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else if (optionKey === userAnswer && userAnswer !== correctAnswer) {
                        label.classList.add('bg-incorrect', 'text-white', 'font-bold');
                        label.classList.remove('hover:bg-cbse-light');
                    } else {
                        label.classList.add('opacity-50');
                    }
                });
            });

            const chapterName = "7. Motion";
            const difficultyLevel = QUIZ_DATA.difficulty || "Medium";

            logFinalQuizScore(score, totalQuestions, chapterName, difficultyLevel);

            const scoreHtml = `
                <div class="p-6 md:p-10 mb-8 text-center bg-cbse-blue text-white rounded-lg shadow-2xl">
                    <h3 class="text-4xl font-extrabold mb-2">Quiz Complete!</h3>
                    <p class="text-6xl font-black">${score}/${totalQuestions}</p>
                    <p class="text-xl font-semibold mt-2">Your Score is: ${((score / totalQuestions) * 100).toFixed(1)}%</p>
                </div>
            `;
            document.getElementById('quiz-container').insertAdjacentHTML('afterbegin', scoreHtml);
            document.getElementById('submit-button').remove();

            document.getElementById('quiz-container').scrollIntoView({ behavior: 'smooth' });
        }


        // --- Supabase Connection and Initialization ---

        function initSupabase() {
            if (quizDataLoaded) { 
                renderDifficultySelection(null); 
                return;
            }

            const configError = document.getElementById('config-error');

            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined') {
                configError.classList.remove('hidden');
                document.getElementById('quiz-container').innerHTML = ''; 
            } else {
                const supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );

                fetchQuizData(supabaseClient);
            }
        }

        async function fetchQuizData(supabaseClient) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow-xl">Fetching Questions from Supabase...</div>`;

            const { data: quizData, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (error) {
                container.innerHTML = `<p class="error-message text-red-700 bg-red-100 p-4 rounded">Error retrieving questions: ${error.message}. Please check RLS policy for the table **${TABLE_NAME}**.</p>`;
                return;
            }

            if (quizData) {
                quizDataLoaded = true;
                renderDifficultySelection(quizData); 
            }
        }
        
        function renderAccessRestrictedView() {
            document.getElementById('quiz-container').innerHTML = `
                <div class="text-center p-6 bg-white rounded-lg shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-cbse-blue">Access Restricted</h2>
                    <p class="text-gray-700 mb-6">Please sign in to start the **Motion** Chapter Quizzes and track your progress.</p>
                    <button class="px-6 py-2 text-white font-bold rounded-lg shadow-md bg-red-600 hover:bg-red-700" onclick="document.getElementById('auth-modal').classList.remove('hidden');">
                        Sign in to Start
                    </button>
                </div>`;
            document.getElementById('auth-modal').classList.remove('hidden'); // Ensure modal is visible
        }


        // CRITICAL FIX: The core state manager with local storage check
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow-xl">Initializing Authentication...</div>`;
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // CRITICAL FIX: Hide modal and then start data load
                    document.getElementById('auth-modal').classList.add('hidden');
                    // Alert that was causing the loop is removed, as the session is now established.
                    initSupabase(); 
                } else if (!localStorage.getItem('auth_in_progress')) {
                    // Only show the restricted view if sign-in is not actively in progress (prevents the loop)
                    renderAccessRestrictedView();
                }
            });
        });
    </script>
</body>
</html>
