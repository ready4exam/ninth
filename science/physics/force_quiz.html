<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force and Laws of Motion Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="../../js/config.js"></script>
    <style>
        /* Custom font and base styling */
        body { font-family: 'Inter', sans-serif; }
        .quiz-card {
            max-width: 800px; /* Increased max width for single-page layout */
            margin: 2rem auto;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .option-label {
            transition: all 0.15s;
        }
        /* Hover state for unselected options */
        .option-label:hover:not(.correct):not(.incorrect) {
            background-color: #f3f4f6;
            border-color: #1a3e6a;
        }
        .correct {
            background-color: #d1fae5 !important;
            border-color: #059669 !important;
            color: #065f46 !important;
        }
        .incorrect {
            background-color: #fee2e2 !important;
            border-color: #dc2626 !important;
            color: #991b1b !important;
        }
        .difficulty-btn {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1a3e6a',
                        'accent-green': '#059669',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 p-4">

    <div id="quiz-container" class="quiz-card bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-8 border-primary-blue">
        
        <h1 class="text-3xl font-extrabold text-primary-blue mb-4 text-center">
            Force and Laws of Motion Quiz
        </h1>
        <p class="text-sm text-gray-500 mb-6 text-center">
            Supabase Table: **force**
        </p>

        <div id="status-message" class="text-center p-4 rounded-lg bg-yellow-100 text-yellow-700 font-medium mb-6">
            Loading quiz configuration...
        </div>

        <div id="start-screen" class="text-center p-8 bg-white rounded-xl shadow-lg hidden">
            <h2 class="text-2xl font-bold text-primary-blue mb-6">Select Difficulty Level</h2>
            <div class="space-y-4">
                <button onclick="startQuiz('Simple')" class="difficulty-btn w-full px-6 py-3 text-lg font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150">
                    Simple
                </button>
                <button onclick="startQuiz('Medium')" class="difficulty-btn w-full px-6 py-3 text-lg font-bold text-white bg-yellow-600 rounded-lg hover:bg-yellow-700 transition duration-150">
                    Medium
                </button>
                <button onclick="startQuiz('Advanced')" class="difficulty-btn w-full px-6 py-3 text-lg font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">
                    Advanced
                </button>
            </div>
        </div>

        <div id="quiz-content" class="hidden">
            
            <p id="difficulty-display" class="text-md font-semibold text-gray-700 mb-6 border-b pb-2"></p>
            
            <div id="question-list" class="space-y-8 mb-8">
                </div>

            <div class="mt-8 sticky bottom-0 bg-white p-4 shadow-2xl rounded-t-xl border-t-2 border-primary-blue">
                <button id="submit-button" onclick="submitQuiz()"
                        class="w-full px-6 py-3 text-lg font-bold text-white bg-primary-blue rounded-lg shadow-md hover:bg-blue-800 transition duration-150">
                    Submit Quiz
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-accent-green mb-4">Quiz Complete! 🎉</h2>
            <p class="text-lg text-gray-700 mb-2">You scored:</p>
            <p id="score-display" class="text-6xl font-extrabold text-primary-blue mb-6">0 / 0</p>
            <button onclick="window.location.reload()"
                    class="px-6 py-3 text-white bg-accent-green rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                Start New Quiz
            </button>
        </div>

    </div>

    <script>
        // --- Configuration ---
        // NOTE: SUPABASE_URL and SUPABASE_ANON_KEY are loaded from 'js/config.js'.
        const SUPABASE_TABLE = 'force'; 
        // ---------------------

        let supabaseClient;
        let questions = [];
        let selectedAnswers = {}; // { qId: 'A' }
        let selectedDifficulty = null; 

        // --- DOM Elements ---
        const statusMessage = document.getElementById('status-message');
        const quizContainer = document.getElementById('quiz-container');
        const quizContent = document.getElementById('quiz-content');
        const resultsScreen = document.getElementById('results-screen');
        const startScreen = document.getElementById('start-screen');
        const questionList = document.getElementById('question-list');
        const submitButton = document.getElementById('submit-button');
        const scoreDisplay = document.getElementById('score-display');
        const difficultyDisplay = document.getElementById('difficulty-display');


        // --- Initialization ---

        function init() {
            // Check for external configuration variables
            if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
                statusMessage.textContent = 'Configuration Error: SUPABASE_URL or SUPABASE_ANON_KEY is undefined. Please ensure "../../js/config.js" is correctly loaded and defines these global variables.';
                statusMessage.className = 'text-center p-4 rounded-lg bg-red-100 text-red-700 font-medium mb-6';
                return;
            }

            try {
                // Accessing the globally defined variables
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Show start screen (assuming this is the intended initial state)
                statusMessage.classList.add('hidden');
                startScreen.classList.remove('hidden');

            } catch (e) {
                statusMessage.textContent = `Error initializing Supabase: ${e.message}`;
                statusMessage.className = 'text-center p-4 rounded-lg bg-red-100 text-red-700 font-medium mb-6';
            }
        }
        
        // --- Start Quiz Function ---
        function startQuiz(difficulty) {
            selectedDifficulty = difficulty;
            difficultyDisplay.textContent = `Difficulty Selected: ${difficulty}`;
            startScreen.classList.add('hidden');
            quizContent.classList.remove('hidden');
            fetchQuestions(difficulty);
        }

        // --- Data Fetching ---

        async function fetchQuestions(difficulty) {
            statusMessage.textContent = `Fetching ${difficulty} questions from table '${SUPABASE_TABLE}'...`;
            statusMessage.classList.remove('hidden');
            
            try {
                let query = supabaseClient
                    .from(SUPABASE_TABLE)
                    .select('*');
                
                // Filter by difficulty (case-insensitive equality)
                if (difficulty) {
                    query = query.ilike('difficulty', difficulty); 
                }
                
                // Order by ID for consistent display
                query = query.order('id', { ascending: true }); 

                const { data, error } = await query;

                if (error) throw error;

                if (data.length === 0) {
                    statusMessage.textContent = `No ${difficulty} questions found in table '${SUPABASE_TABLE}'. Please upload data using the CSV Uploader.`;
                    statusMessage.className = 'text-center p-4 rounded-lg bg-yellow-100 text-yellow-700 font-medium mb-6';
                    return;
                }

                questions = data;
                statusMessage.classList.add('hidden'); // Hide status on success
                renderQuestions(); // Render all questions
                submitButton.disabled = false;

            } catch (error) {
                console.error('Error fetching questions:', error);
                statusMessage.textContent = `Error loading questions: ${error.message}`;
                statusMessage.className = 'text-center p-4 rounded-lg bg-red-100 text-red-700 font-medium mb-6';
            }
        }
        
        // --- Answer Storage ---
        function storeAnswer(questionId, selectedKey) {
            selectedAnswers[questionId] = selectedKey;
        }

        // --- Rendering Logic (All questions at once) ---
        function renderQuestions() {
            questionList.innerHTML = '';
            questions.forEach((q, index) => {
                const questionHtml = createQuestionHtml(q, index);
                questionList.innerHTML += questionHtml;
            });
        }

        function createQuestionHtml(q, index) {
            const questionNumber = index + 1;
            const optionKeys = ['A', 'B', 'C', 'D'];

            // Generate options using radio buttons
            const optionsHtml = optionKeys.map(key => `
                <label class="option-label block w-full text-left p-3 border-2 border-gray-300 rounded-xl font-medium text-gray-800 transition duration-100 shadow-sm cursor-pointer" data-key="${key}">
                    <input type="radio" name="question_${q.id}" value="${key}" class="mr-3" onchange="storeAnswer('${q.id}', '${key}')">
                    <span class="font-bold mr-1">${key}.</span> ${q[`option_${key.toLowerCase()}`] || `(Option ${key} missing)`}
                </label>
            `).join('');

            return `
                <div class="question-item p-5 bg-white rounded-xl shadow-lg border-l-4 border-primary-blue" data-q-id="${q.id}">
                    <p class="text-lg font-semibold text-primary-blue mb-3">${questionNumber}. ${q.question_text || 'Error: Missing question text.'}</p>
                    ${q.scenario_reason_text ? `<p class="text-sm italic text-gray-600 mb-4 bg-gray-50 p-2 rounded">Context/Reason: ${q.scenario_reason_text}</p>` : ''}
                    <div class="options-group space-y-2">
                        ${optionsHtml}
                    </div>
                    <div class="feedback-box mt-3 text-sm font-bold p-2 rounded hidden"></div>
                </div>
            `;
        }
        
        // --- Submission Logic ---
        function submitQuiz() {
            let finalScore = 0;
            
            // Disable submission button while processing
            submitButton.disabled = true;
            submitButton.textContent = 'Calculating Score...';

            questions.forEach(q => {
                const questionElement = document.querySelector(`.question-item[data-q-id="${q.id}"]`);
                const feedbackBox = questionElement.querySelector('.feedback-box');
                const correctKey = q.correct_answer_key;
                const selectedKey = selectedAnswers[q.id];
                let isCorrect = false;

                // Check answer and update score
                if (selectedKey && selectedKey === correctKey) {
                    finalScore++;
                    isCorrect = true;
                }

                // Highlight options and show feedback
                const optionLabels = questionElement.querySelectorAll('.option-label');
                optionLabels.forEach(label => {
                    const labelKey = label.getAttribute('data-key');
                    const radioInput = label.querySelector('input');
                    radioInput.disabled = true; // Disable all inputs after submission
                    
                    label.classList.remove('hover:bg-gray-50');

                    if (labelKey === correctKey) {
                        // Highlight correct answer
                        label.classList.add('correct', 'shadow-md');
                        feedbackBox.textContent = isCorrect ? '✅ Correct Answer!' : `✅ Correct answer: ${correctKey}.`;
                        feedbackBox.classList.add('bg-green-100', 'text-green-700');
                    } else if (labelKey === selectedKey && !isCorrect) {
                        // Highlight user's incorrect answer
                        label.classList.add('incorrect', 'shadow-md');
                        if (!feedbackBox.textContent) { // Only set feedback if not already set by correct answer
                            feedbackBox.textContent = `❌ Incorrect. The correct answer is ${correctKey}.`;
                            feedbackBox.classList.add('bg-red-100', 'text-red-700');
                        }
                    }
                });
                
                // Handle unanswered questions
                if (!selectedKey) {
                    feedbackBox.textContent = '❓ Unanswered.';
                    feedbackBox.classList.add('bg-yellow-100', 'text-yellow-700');
                }

                feedbackBox.classList.remove('hidden');
            });

            // Show results
            score = finalScore;
            // Scroll to the top of the quiz container before showing results screen
            quizContainer.scrollIntoView({ behavior: 'smooth' });
            setTimeout(showResults, 1000); 
        }

        function showResults() {
            quizContent.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            scoreDisplay.textContent = `${score} / ${questions.length}`;
        }

        // Start the quiz when the window loads
        window.onload = init;
    </script>
</body>
</html>
```eof
