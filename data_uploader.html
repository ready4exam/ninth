<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Uploader Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script src="./js/config.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'primary-blue': '#1a3e6a',
                        'accent-green': '#059669',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen antialiased p-4">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-8 border-primary-blue">
        <h1 class="text-3xl font-extrabold text-primary-blue mb-4">CSV Quiz Processor & Uploader</h1>
        <p class="text-gray-600 mb-6">
            **Step 1: Generate CSV.** Use your Gemini prompt to generate the 60 questions and copy the entire CSV output (including the header row).<br>
            **Step 2: Paste & Upload.** Paste the CSV below, specify the table, and click upload.
        </p>

        <div class="space-y-4 mb-6">
            <div>
                <label for="table-name" class="block text-sm font-medium text-gray-700">Target Supabase Table Name</label>
                <input type="text" id="table-name" value="motion" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-accent-green focus:border-accent-green">
            </div>
            <div>
                <label for="csv-input" class="block text-sm font-medium text-gray-700">Paste Gemini CSV Output Here (Including Header)</label>
                <textarea id="csv-input" rows="10" placeholder="Paste your 60-question CSV output from Gemini here..." class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-accent-green focus:border-accent-green"></textarea>
            </div>
        </div>

        <button id="automate-button" onclick="startAutomation()"
                class="w-full px-6 py-3 text-lg font-bold text-white bg-accent-green rounded-lg shadow-md hover:bg-green-700 transition duration-150">
            2. Parse CSV & Insert Data into Supabase
        </button>

        <div id="status-log" class="mt-8 space-y-2">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Process Log:</h2>
            <p id="log-initial" class="text-gray-500">Ready to start...</p>
        </div>
        
        <div id="config-error" class="hidden error-message mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            **Configuration Error ðŸ›‘** Supabase credentials (`SUPABASE_URL`, `SUPABASE_ANON_KEY`) were not found. Please ensure the file **./js/config.js** exists and contains the correct definitions.
        </div>
    </div>

    <script>
        // --- Supabase and Database Constants ---
        // The column order must strictly match the CSV header:
        // Difficulty, Question_Type, Question_Text, Scenario_Reason_Text, Option_A, Option_B, Option_C, Option_D, Correct_Answer_Key
        const DB_COLUMNS = [
            'difficulty', 'question_type', 'question_text', 
            'scenario_reason_text', 'option_a', 'option_b', 'option_c', 'option_d', 
            'correct_answer_key'
        ];

        let supabaseClient;
        let button;
        let log;

        // --- Utility Functions ---

        function init() {
            log = document.getElementById('status-log');
            button = document.getElementById('automate-button');
            
            // Check the globally exposed variables, which should be loaded from ./js/config.js
            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined' || window.SUPABASE_URL === null) {
                 document.getElementById('log-initial').textContent = "Configuration required...";
                 document.getElementById('config-error').classList.remove('hidden');
                 button.disabled = true;
                 return;
            }
            
            document.getElementById('log-initial').textContent = "Initializing environment...";
            
            // Initialize Supabase Client
            try {
                supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );
                logMessage('Supabase client initialized successfully. Ready to process CSV.', 'success');
            } catch (e) {
                logMessage(`Error initializing Supabase client: ${e.message}`, 'error');
                button.disabled = true;
            }
        }

        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`; // Use innerHTML for bolding
            p.className = 'p-2 rounded';
            
            if (type === 'info') p.classList.add('bg-gray-100', 'text-gray-700');
            if (type === 'success') p.classList.add('bg-green-100', 'text-accent-green', 'font-semibold');
            if (type === 'error') p.classList.add('bg-red-100', 'text-red-700', 'font-semibold');
            if (type === 'warning') p.classList.add('bg-yellow-100', 'text-yellow-700');

            // Insert new message at the top of the log
            const logContainer = document.getElementById('status-log');
            const firstLogEntry = logContainer.querySelector('h2').nextElementSibling;
            logContainer.insertBefore(p, firstLogEntry);
        }

        function setButtonState(disabled, text) {
            button.disabled = disabled;
            button.textContent = text;
        }
        
        // --- CSV Parsing Logic ---

        function parseCSV(csvString) {
            logMessage('Parsing CSV data...');
            const lines = csvString.trim().split('\n');
            if (lines.length < 2) {
                throw new Error("CSV input must contain at least a header row and one data row.");
            }
            
            // Simple split by comma, handling potential quotes for data integrity
            const header = lines[0].split(',').map(h => h.trim().replace(/['"]+/g, ''));
            const data = [];
            
            // Check if the provided header matches the expected DB columns
            // We ignore 'created_at' here as we'll add it in the final object.
            const expectedHeader = DB_COLUMNS.filter(col => col !== 'created_at'); 
            if (header.length < expectedHeader.length || !header.every((h, i) => h.toLowerCase().includes(expectedHeader[i].toLowerCase()))) {
                logMessage(`Warning: Header mismatch. Expected columns (in order): ${expectedHeader.join(', ')}`, 'warning');
                logMessage(`Found header columns: ${header.join(', ')}`, 'warning');
            }


            // Use a regex to robustly split lines by comma while respecting quoted fields
            const csvRegex = /(".*?"|[^",\n\r]+)(?=\s*,|\s*$)/g;

            // Start from line 1 to skip the header
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === "") continue; // Skip empty lines
                
                // Match the values using regex
                const values = lines[i].match(csvRegex) || [];
                if (values.length < DB_COLUMNS.length - 1) { // We expect 9 columns from the CSV (excluding created_at)
                    logMessage(`Skipping line ${i + 1} due to insufficient columns (${values.length} found).`, 'warning');
                    continue;
                }

                let rowData = {};
                const now = new Date().toISOString();
                rowData['created_at'] = now; // Add the required timestamp

                // Map values to DB_COLUMNS (starting with index 1 because we manually set created_at)
                for (let j = 0; j < DB_COLUMNS.length - 1; j++) {
                    const colName = DB_COLUMNS[j];
                    let value = values[j] ? values[j].trim().replace(/^"|"$/g, '') : ""; // Remove surrounding quotes

                    // Clean up null/empty strings for scenario_reason_text
                    if (colName === 'scenario_reason_text' && (value === '' || value.toLowerCase() === 'null')) {
                        value = null; // Supabase prefers actual null, but we'll use an empty string for simplicity here.
                    }

                    // Map to the correct object key
                    rowData[colName] = value;
                }
                
                data.push(rowData);
            }
            
            logMessage(`Successfully parsed **${data.length}** records from CSV.`, 'success');
            return data;
        }


        // --- Supabase Insertion Logic (Unchanged) ---

        async function insertDataIntoSupabase(tableName, data) {
            logMessage(`Attempting to insert ${data.length} records into table **${tableName}**...`);
            
            // Supabase bulk insert
            const { data: insertedData, error } = await supabaseClient
                .from(tableName)
                .insert(data)
                .select(); 

            if (error) {
                // Check if the error is related to RLS being disabled (a common issue)
                if (error.message.includes("permission denied")) {
                     throw new Error(`Supabase insertion error: Permission Denied. Check that **Row Level Security (RLS)** is enabled for table '${tableName}' and that the Anon key policy allows inserts.`);
                }
                throw new Error(`Supabase insertion error: ${error.message}`);
            }

            return insertedData;
        }

        // --- Main Automation Workflow ---

        async function startAutomation() {
            if (!supabaseClient) {
                logMessage('Initialization failed. Please check configuration and try again.', 'error');
                return;
            }
            
            const tableName = document.getElementById('table-name').value.trim();
            const csvInput = document.getElementById('csv-input').value.trim();
            
            if (!tableName) {
                logMessage('Table Name is required.', 'error');
                return;
            }
            if (!csvInput) {
                logMessage('Please paste the CSV data into the text area.', 'error');
                return;
            }

            setButtonState(true, 'Processing: Parsing CSV...');
            
            try {
                // 1. Parse CSV Data
                const quizData = parseCSV(csvInput);
                
                if (!quizData || quizData.length === 0) {
                    throw new Error("No valid data rows were parsed from the CSV.");
                }
                logMessage(`Content Parsed: Ready to insert **${quizData.length}** records.`, 'success');

                // 2. Insert Data into Supabase
                setButtonState(true, 'Processing: Inserting into Supabase...');
                const insertedRecords = await insertDataIntoSupabase(tableName, quizData);
                
                // 3. Complete
                logMessage(`2. Data successfully inserted! **${insertedRecords.length}** records added to table **${tableName}**.`, 'success');
                logMessage('Automation Complete. You can now process another CSV.', 'success');
                setButtonState(false, 'Upload Another CSV');

            } catch (error) {
                logMessage(`Automation Failed: ${error.message}`, 'error');
                setButtonState(false, 'Error. Check Log and Try Again.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
        
        // Expose functions to the global scope for use in inline HTML attributes (onclick)
        window.startAutomation = startAutomation;
    </script>
</body>
</html>
```eof

### How to use the new file:

1.  **Generate your CSV** using the prompt I provided earlier.
2.  **Copy the entire CSV text** (including the header row).
3.  **Paste the text** into the new large text area labeled "Paste Gemini CSV Output Here".
4.  Ensure your **"Target Supabase Table Name"** is correct.
5.  Click the **"2. Parse CSV & Insert Data into Supabase"** button.

The script will handle the conversion and insert the data directly into your Supabase table. Good luck!
