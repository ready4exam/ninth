<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Uploader Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script src="./js/config.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        'primary-blue': '#1a3e6a',
                        'accent-green': '#059669',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen antialiased p-4">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-8 border-primary-blue">
        <h1 class="text-3xl font-extrabold text-primary-blue mb-4">CSV Quiz Processor & Uploader</h1>
        <p class="text-gray-600 mb-6">
            **Step 1: Generate CSV.** Use your Gemini prompt to generate the 60 questions and copy the entire CSV output (including the header row).<br>
            **Step 2: Paste & Upload.** Paste the CSV below, specify the table, and click upload. **NOTE: If using Gemini output, manually search and replace any instances of 'nan' in the options with an empty string or 'N/A' before pasting.**
        </p>

        <div class="space-y-4 mb-6">
            <div>
                <label for="table-name" class="block text-sm font-medium text-gray-700">Target Supabase Table Name</label>
                <input type="text" id="table-name" value="motion" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-accent-green focus:border-accent-green">
            </div>
            <div>
                <label for="csv-input" class="block text-sm font-medium text-gray-700">Paste Gemini CSV Output Here (Including Header)</label>
                <textarea id="csv-input" rows="10" placeholder="Paste your 60-question CSV output from Gemini here..." class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-accent-green focus:border-accent-green"></textarea>
            </div>
        </div>

        <button id="automate-button" onclick="startAutomation()"
                class="w-full px-6 py-3 text-lg font-bold text-white bg-accent-green rounded-lg shadow-md hover:bg-green-700 transition duration-150">
            2. Parse CSV & Insert Data into Supabase
        </button>

        <div id="status-log" class="mt-8 space-y-2">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Process Log:</h2>
            <p id="log-initial" class="text-gray-500">Ready to start...</p>
        </div>
        
        <div id="config-error" class="hidden error-message mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            **Configuration Error ðŸ›‘** Supabase credentials (`SUPABASE_URL`, `SUPABASE_ANON_KEY`) were not found. Please ensure the file **./js/config.js** exists and contains the correct definitions.
        </div>
    </div>

    <script>
        // --- Supabase and Database Constants ---
        // The column order must strictly match the CSV header.
        const DB_COLUMNS = [
            'difficulty', 'question_type', 'question_text', 
            'scenario_reason_text', 'option_a', 'option_b', 'option_c', 'option_d', 
            'correct_answer_key'
        ];

        let supabaseClient;
        let button;
        let log;

        // --- Utility Functions ---

        function init() {
            log = document.getElementById('status-log');
            button = document.getElementById('automate-button');
            
            // Check the globally exposed variables, which should be loaded from ./js/config.js
            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined' || window.SUPABASE_URL === null) {
                 document.getElementById('log-initial').textContent = "Configuration required...";
                 document.getElementById('config-error').classList.remove('hidden');
                 button.disabled = true;
                 return;
            }
            
            document.getElementById('log-initial').textContent = "Initializing environment...";
            
            // Initialize Supabase Client
            try {
                supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );
                logMessage('Supabase client initialized successfully. Ready to process CSV.', 'success');
            } catch (e) {
                logMessage(`Error initializing Supabase client: ${e.message}`, 'error');
                button.disabled = true;
            }
        }

        function logMessage(message, type = 'info') {
            const p = document.createElement('p');
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`; // Use innerHTML for bolding
            p.className = 'p-2 rounded';
            
            if (type === 'info') p.classList.add('bg-gray-100', 'text-gray-700');
            if (type === 'success') p.classList.add('bg-green-100', 'text-accent-green', 'font-semibold');
            if (type === 'error') p.classList.add('bg-red-100', 'text-red-700', 'font-semibold');
            if (type === 'warning') p.classList.add('bg-yellow-100', 'text-yellow-700');

            // Insert new message at the top of the log
            const logContainer = document.getElementById('status-log');
            const firstLogEntry = logContainer.querySelector('h2').nextElementSibling;
            logContainer.insertBefore(p, firstLogEntry);
        }

        function setButtonState(disabled, text) {
            button.disabled = disabled;
            button.textContent = text;
        }
        
        // --- Robust CSV Parsing Logic ---

        // Regex to split by comma while respecting quoted fields.
        const CSV_REGEX = /(?!\s*$",)(?!\s*$)\s*(?:(?:"((?:[^"]|"")*)")|([^",]*))\s*(?:,|$)/g;

        function parseCSV(csvString) {
            logMessage('Parsing CSV data...');
            
            // Added check to ensure the string is clean of common non-text issues like BOM
            const cleanString = csvString.trim().replace(/^\uFEFF/, '');
            const lines = cleanString.split('\n');
            
            if (lines.length < 2) {
                throw new Error("CSV input must contain at least a header row and one data row.");
            }
            
            // --- 1. Header Check (Unchanged from last fix) ---
            const headerLine = lines[0];
            const header = headerLine.split(',').map(h => h.trim().replace(/['"]+/g, '').toLowerCase());
            const expectedHeader = DB_COLUMNS.map(col => col.toLowerCase()); 
            
            const headerMatch = expectedHeader.every((expectedCol, i) => 
                header[i] && header[i].includes(expectedCol)
            );

            if (!headerMatch) {
                logMessage(`Error: Header mismatch. Please ensure the header is: ${DB_COLUMNS.join(', ')}`, 'error');
                logMessage(`Found header columns: ${header.join(', ')}`, 'error');
                throw new Error("CSV Header mismatch. Check the log for required vs. found columns.");
            }
            
            // --- 2. Data Parsing ---
            const data = [];
            const timestampCol = 'created_at';
            
            // Iterate over data rows starting from line 1
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === "") continue; // Skip empty lines

                // Robustly extract fields using the regex
                const fields = line.match(CSV_REGEX);

                if (!fields || fields.length < DB_COLUMNS.length) {
                    logMessage(`Skipping row ${i + 1} due to insufficient columns (${fields ? fields.length : 0} found).`, 'warning');
                    continue;
                }

                let rowData = {};
                rowData[timestampCol] = new Date().toISOString(); // Add the required timestamp

                // Map the first 9 extracted fields to the 9 DB columns
                for (let j = 0; j < DB_COLUMNS.length; j++) {
                    const colName = DB_COLUMNS[j];
                    const field = fields[j];

                    // Extract content from regex match groups and remove quotes
                    // This handles quoted fields and unquoted fields
                    let value = field.match(/"((?:[^"]|"")*)"|([^",]*)/)?.[1] || field.match(/"((?:[^"]|"")*)"|([^",]*)/)?.[2];
                    
                    // Final cleanup for the value
                    value = value ? value.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "";
                    
                    // NEW: Explicitly handle 'nan' and 'NaN' as null values
                    if (value.toLowerCase() === 'nan' || value === '' || value.toLowerCase() === 'null') {
                        value = null;
                    }

                    // Map to the final object key
                    rowData[colName] = value;
                }
                
                // Final check to ensure we have all required keys (including created_at)
                if (Object.keys(rowData).length === DB_COLUMNS.length + 1) {
                    data.push(rowData);
                } else {
                    logMessage(`Skipping row ${i + 1}: Final object missing keys.`, 'warning');
                }
            }
            
            if (data.length === 0) {
                 throw new Error("Failed to parse any valid data rows. Check the CSV format for extra commas or incorrect quoting.");
            }

            logMessage(`Successfully parsed **${data.length}** records from CSV.`, 'success');
            return data;
        }


        // --- Supabase Insertion Logic (Unchanged) ---

        async function insertDataIntoSupabase(tableName, data) {
            logMessage(`Attempting to insert ${data.length} records into table **${tableName}**...`);
            
            // Supabase bulk insert
            const { data: insertedData, error } = await supabaseClient
                .from(tableName)
                .insert(data)
                .select(); 

            if (error) {
                // Check if the error is related to RLS being disabled (a common issue)
                if (error.message.includes("permission denied")) {
                     throw new Error(`Supabase insertion error: Permission Denied. Check that **Row Level Security (RLS)** is enabled for table '${tableName}' and that the Anon key policy allows inserts.`);
                }
                throw new Error(`Supabase insertion error: ${error.message}`);
            }

            return insertedData;
        }

        // --- Main Automation Workflow ---

        async function startAutomation() {
            if (!supabaseClient) {
                logMessage('Initialization failed. Please check configuration and try again.', 'error');
                return;
            }
            
            const tableName = document.getElementById('table-name').value.trim();
            const csvInput = document.getElementById('csv-input').value.trim();
            
            if (!tableName) {
                logMessage('Table Name is required.', 'error');
                return;
            }
            if (!csvInput) {
                logMessage('Please paste the CSV data into the text area.', 'error');
                return;
            }

            setButtonState(true, 'Processing: Parsing CSV...');
            
            try {
                // 1. Parse CSV Data
                const quizData = parseCSV(csvInput);
                
                if (!quizData || quizData.length === 0) {
                    throw new Error("No valid data rows were parsed from the CSV.");
                }
                logMessage(`Content Parsed: Ready to insert **${quizData.length}** records.`, 'success');

                // 2. Insert Data into Supabase
                setButtonState(true, 'Processing: Inserting into Supabase...');
                const insertedRecords = await insertDataIntoSupabase(tableName, quizData);
                
                // 3. Complete
                logMessage(`2. Data successfully inserted! **${insertedRecords.length}** records added to table **${tableName}**.`, 'success');
                logMessage('Automation Complete. You can now process another CSV.', 'success');
                setButtonState(false, 'Upload Another CSV');

            } catch (error) {
                logMessage(`Automation Failed: ${error.message}`, 'error');
                setButtonState(false, 'Error. Check Log and Try Again.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
        
        // Expose functions to the global scope for use in inline HTML attributes (onclick)
        window.startAutomation = startAutomation;
    </script>
</body>
</html>
```eof

### Instructions for Final Attempt

1.  **Update the HTML** with the code above.
2.  **Manually Inspect the CSV:** Even with the code fix, it's best practice to quickly check the Gemini CSV output in a text editor. If you see lines where `option_a` is `nan`, delete the `nan` and ensure the commas line up correctly.
3.  **Paste & Run:** Paste the clean CSV into the tool and run the upload. The explicit handling of `nan` as `null` should fix the column shifting problem.
