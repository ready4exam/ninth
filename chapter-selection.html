<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Chapter & Difficulty</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Merriweather:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f5f7fa; }
        .cbse-blue { background-color: #1a3e6a; }
        .cbse-light { background-color: #f5f7fa; }
        .card { @apply bg-white p-6 rounded-xl shadow-lg transition-transform duration-300; }
        .chapter-card { cursor: pointer; }
        .chapter-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .selected-chapter { @apply border-4 border-blue-500 ring-2 ring-blue-500 shadow-xl; }
        .selected-difficulty { @apply bg-blue-600 text-white shadow-lg ring-4 ring-blue-300; }

        /* Custom style for difficulty buttons */
        .difficulty-btn > * {
            pointer-events: none; /* Allows click events on button children to register on the button */
        }
    </style>
</head>
<body>
    
    <header class="header-bg bg-cbse-blue shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-extrabold text-white tracking-tight hover:text-accent-gold transition">
                Ready4Exam
            </a>
            <button id="logout-nav-btn" class="hidden text-sm py-2 px-4 rounded-full bg-red-500 text-white font-semibold transition hover:bg-red-600">
                üö™ Logout
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10 mb-16">
        
        <div class="mb-8">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-2">
                <span id="class-title-display">Class 9</span>: Select Topic
            </h2>
            <p class="text-lg text-gray-500" id="subject-selection-info">
                Choose a subject to view the available chapters.
            </p>
        </div>
        
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" id="subject-tabs-container" aria-label="Tabs">
                </nav>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-3">
                <div id="subject-content-container">
                    </div>
            </div>

            <div class="lg:col-span-1 card sticky top-4 h-fit">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Quiz Settings</h3>
                
                <div id="selected-topic-display" class="mb-6 p-3 bg-blue-50 rounded-lg text-center border-l-4 border-blue-500 hidden">
                    <p class="text-sm font-semibold text-blue-700">Topic Selected:</p>
                    <p class="text-xl font-extrabold text-blue-900 truncate" id="selected-topic-name">
                        -- Select Chapter --
                    </p>
                </div>

                <p class="text-lg font-semibold text-gray-700 mb-3">Select Difficulty:</p>
                
                <div id="difficulty-selection-container" class="space-y-4">
                    <button data-difficulty="simple" class="difficulty-btn w-full flex items-center justify-between p-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition duration-150">
                        <span>Simple</span>
                        <i data-lucide="sun" class="w-5 h-5"></i>
                    </button>
                    <button data-difficulty="medium" class="difficulty-btn w-full flex items-center justify-between p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 selected-difficulty">
                        <span>Medium (Recommended)</span>
                        <i data-lucide="award" class="w-5 h-5"></i>
                    </button>
                    <button data-difficulty="advanced" class="difficulty-btn w-full flex items-center justify-between p-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition duration-150">
                        <span>Advanced</span>
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="mt-8">
                    <p id="error-message" class="text-red-600 mb-4 font-medium hidden">
                        ‚ö†Ô∏è Please select a chapter before starting.
                    </p>
                    <button id="start-quiz-btn" class="w-full py-4 bg-green-600 text-white rounded-xl font-extrabold text-xl hover:bg-green-700 transition shadow-lg">
                        Start Quiz
                        <i data-lucide="arrow-right" class="w-5 h-5 inline ml-2"></i>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-cbse-blue mt-16 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <small class="text-sm opacity-70 block mt-2">¬© 2025 Ready4Exam Academic Portal. All Rights Reserved.</small>
        </div>
    </footer>


    <script type="module" src="./js/config.js"></script>
    <script type="module" src="./js/auth-paywall.js"></script>
    <script type="module">
        // NOTE: We import 'curriculumData' which matches the export in js/curriculum.js
        import { curriculumData } from './js/curriculum.js'; 
        import { updateAuthUI, signOut, getElements } from './js/ui-renderer.js';
        import { initializeAuthListener } from './js/auth-paywall.js';

        // --- State Management ---
        const params = new URLSearchParams(window.location.search);
        const currentClassKey = params.get('class');
        
        let selectedTopic = null;      // Stores the chapter 'id' slug
        let selectedDifficulty = 'medium'; // Stores the selected difficulty
        let currentSubjectKey = 'Science'; // Stores the currently active subject tab

        // --- DOM Elements ---
        const elements = {
            classTitleDisplay: document.getElementById('class-title-display'),
            subjectTabsContainer: document.getElementById('subject-tabs-container'),
            subjectContentContainer: document.getElementById('subject-content-container'),
            difficultySelectionContainer: document.getElementById('difficulty-selection-container'),
            startQuizBtn: document.getElementById('start-quiz-btn'),
            errorMessageEl: document.getElementById('error-message'),
            selectedTopicNameEl: document.getElementById('selected-topic-name'),
            selectedTopicDisplay: document.getElementById('selected-topic-display'),
            logoutNavBtn: document.getElementById('logout-nav-btn'),
        }

        // --- Core Functions ---

        /**
         * Renders all subject tabs and the content for the initially selected subject.
         */
        function renderSubjects() {
            if (!currentClassKey || !curriculumData[currentClassKey]) {
                alert('Invalid class selected. Returning to home.');
                window.location.href = 'index.html';
                return;
            }

            const classData = curriculumData[currentClassKey];
            const subjects = Object.keys(classData);

            // 1. Render Subject Tabs
            elements.subjectTabsContainer.innerHTML = '';
            // Default to the first subject key if none is set or if 'Science' isn't available
            currentSubjectKey = subjects.includes('Science') ? 'Science' : subjects[0]; 

            subjects.forEach(subjectKey => {
                const isActive = subjectKey === currentSubjectKey;
                const tabHtml = `
                    <button data-subject="${subjectKey}" 
                            class="subject-tab ${isActive ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} 
                            whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg transition duration-150">
                        ${subjectKey.replace('_', ' ')}
                    </button>
                `;
                elements.subjectTabsContainer.innerHTML += tabHtml;
            });

            // 2. Render Content for the initial subject
            renderSubjectContent(currentSubjectKey);
        }
        
        /**
         * Renders the streams and chapters for the given subject key.
         * @param {string} subjectKey - e.g., 'Science', 'Mathematics', 'Social_Science'
         */
        function renderSubjectContent(subjectKey) {
            elements.subjectContentContainer.innerHTML = ''; // Clear previous content
            selectedTopic = null; // Reset selection when changing subjects
            updateSelectedTopicDisplay(); // Update display to clear previous topic

            const classData = curriculumData[currentClassKey];
            const subjectData = classData[subjectKey];

            let html = '';

            // Iterate through Streams (e.g., Physics, History, General)
            for (const [streamKey, chapters] of Object.entries(subjectData)) {
                
                // Stream Header
                html += `
                    <h3 class="text-3xl font-extrabold text-heading mt-8 mb-6 border-b pb-2">
                        ${subjectKey.replace('_', ' ')}: ${streamKey.replace('_', ' ')}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-12">
                `;

                // Chapter Cards
                chapters.forEach(chapter => {
                    html += `
                        <div class="chapter-card card border-2 border-gray-100" 
                            data-id="${chapter.id}" 
                            data-title="${chapter.title}" 
                            data-subject="${subjectKey}">
                            <p class="text-sm font-semibold text-gray-500 mb-1">${streamKey.replace('_', ' ')}</p>
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${chapter.title}</h4>
                            <p class="text-gray-600 text-sm">Quiz available for topic: ${chapter.id.replace(/_/g, ' ')}</p>
                        </div>
                    `;
                });

                html += '</div>'; // Close grid
            }

            elements.subjectContentContainer.innerHTML = html;
            attachChapterEventListeners();
        }

        /**
         * Attaches click listeners to the dynamically rendered chapter cards.
         */
        function attachChapterEventListeners() {
            document.querySelectorAll('.chapter-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    handleChapterSelection(e.currentTarget);
                });
            });
        }
        
        /**
         * Handles the selection of a chapter card.
         * @param {HTMLElement} cardEl - The selected chapter card element.
         */
        function handleChapterSelection(cardEl) {
            // 1. Deselect all chapters
            document.querySelectorAll('.chapter-card').forEach(c => {
                c.classList.remove('selected-chapter');
            });

            // 2. Select the current chapter
            cardEl.classList.add('selected-chapter');

            // 3. Update state variables
            selectedTopic = cardEl.dataset.id;
            currentSubjectKey = cardEl.dataset.subject; // Store subject for URL passing

            // 4. Update display
            updateSelectedTopicDisplay(cardEl.dataset.title);

            // 5. Hide error message
            elements.errorMessageEl.classList.add('hidden');
        }

        /**
         * Handles the selection of a difficulty button.
         * @param {string} difficulty - The difficulty key ('simple', 'medium', 'advanced').
         * @param {HTMLElement} buttonEl - The selected button element.
         */
        function handleDifficultySelection(difficulty, buttonEl) {
            // 1. Deselect all difficulty buttons
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected-difficulty');
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'ring-4', 'ring-blue-300');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            });

            // 2. Select the current difficulty button
            buttonEl.classList.add('selected-difficulty');
            buttonEl.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            buttonEl.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'ring-4', 'ring-blue-300');


            // 3. Update state
            selectedDifficulty = difficulty;
        }
        
        /**
         * Updates the display area for the currently selected chapter.
         * @param {string} title - The chapter title.
         */
        function updateSelectedTopicDisplay(title = '-- Select Chapter --') {
            elements.selectedTopicNameEl.textContent = title;
            if (title === '-- Select Chapter --') {
                elements.selectedTopicDisplay.classList.add('hidden');
            } else {
                elements.selectedTopicDisplay.classList.remove('hidden');
            }
        }

        /**
         * Handles the final click on the 'Start Quiz' button.
         */
        function handleStartQuiz() {
            if (!selectedTopic) {
                elements.errorMessageEl.classList.remove('hidden');
                return;
            }
            
            elements.errorMessageEl.classList.add('hidden');

            // Build the URL with all four required parameters (Class, Subject, Topic, Difficulty)
            const url = `quiz-engine.html?class=${currentClassKey}&subject=${currentSubjectKey}&topic=${selectedTopic}&difficulty=${selectedDifficulty}`;
            
            // Navigate to the quiz engine
            window.location.href = url;
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set the Class title display
            elements.classTitleDisplay.textContent = `Class ${currentClassKey}`;
            
            // Render the full curriculum structure for the class
            renderSubjects();
            
            // Attach event listeners for subject tabs (must be done after rendering subjects)
            elements.subjectTabsContainer.querySelectorAll('.subject-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const newSubjectKey = e.currentTarget.dataset.subject;
                    if (newSubjectKey !== currentSubjectKey) {
                        currentSubjectKey = newSubjectKey;
                        // Re-render everything to update UI
                        renderSubjects(); 
                    }
                });
            });

            // Attach event listeners for difficulty buttons
            elements.difficultySelectionContainer.querySelectorAll('.difficulty-btn').forEach(btn => {
                // Use e.currentTarget to ensure the event listener always refers to the button
                btn.addEventListener('click', (e) => {
                    const clickedButton = e.currentTarget; 
                    handleDifficultySelection(clickedButton.dataset.difficulty, clickedButton);
                });
            });
            
            // Pre-select 'medium' difficulty on load
            // The logic inside handleDifficultySelection ensures the correct styling is applied
            document.querySelector('.difficulty-btn[data-difficulty="medium"]').click();

            // Start Quiz Button
            elements.startQuizBtn.addEventListener('click', handleStartQuiz);

            // Auth Listener and UI Setup
            initializeAuthListener(updateAuthUI);
            elements.logoutNavBtn.addEventListener('click', signOut);

            // Re-render Lucide icons
            lucide.createIcons();
        });
    </script>
</body>
</html>
