<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Chapter & Difficulty</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        'cbse-blue': '#1a3e6a', 
                        'cbse-light': '#f5f7fa',
                        'accent-gold': '#ffb703',
                        'heading': '#0f172a',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .cbse-blue { background-color: #1a3e6a; }
        .cbse-light { background-color: #f5f7fa; }
        .header-bg { background-color: #1a3e6a; } /* Using cbse-blue for consistency */
        .card { @apply bg-white p-5 rounded-xl shadow-lg transition-all duration-300 hover:shadow-xl; }
        .difficulty-btn {
            @apply px-6 py-3 rounded-xl font-bold border-2 transition-all duration-200 shadow-md;
        }
        .difficulty-btn:hover {
            @apply scale-[1.02];
        }
        .difficulty-btn.simple { @apply bg-green-50 border-green-400 text-green-700; }
        .difficulty-btn.medium { @apply bg-yellow-50 border-yellow-400 text-yellow-700; }
        .difficulty-btn.advance { @apply bg-red-50 border-red-400 text-red-700; }

        .difficulty-btn.selected {
            @apply ring-4 ring-offset-2 ring-cbse-blue border-cbse-blue shadow-2xl;
        }
        .chapter-card.selected {
            @apply ring-2 ring-cbse-blue bg-blue-50/50 shadow-inner;
        }
    </style>
</head>
<body class="bg-cbse-light min-h-screen flex flex-col">

    <!-- HEADER: Consistent Branding -->
    <header class="bg-cbse-blue shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <span class="text-2xl font-bold text-white tracking-wider">Ready4Exam</span>
                    <span class="text-xs text-accent-gold block -mt-1 opacity-80">A ready4industry initiative</span>
                </div>
                <nav class="hidden md:block">
                    <a href="index.html" class="text-white hover:text-accent-gold px-3 py-2 rounded-md text-sm font-medium transition duration-150">Class 9 Home</a>
                </nav>
                <div id="auth-nav-container" class="flex items-center space-x-2">
                    <!-- Auth UI will be rendered here by UI-Renderer -->
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white p-8 rounded-xl shadow-2xl">
            <h1 id="main-title" class="text-3xl font-extrabold text-heading mb-2">Select Subject & Chapter</h1>
            <p id="sub-title" class="text-lg text-gray-600 mb-8">Class 9 / <span id="subject-name">...</span></p>

            <!-- 1. Sub-Subject Selection (For Science) -->
            <div id="sub-subject-selection" class="mb-10 hidden">
                <h2 class="text-2xl font-bold text-cbse-blue mb-4 flex items-center"><i data-lucide="layers" class="h-6 w-6 mr-2"></i> Choose Stream</h2>
                <div id="sub-subject-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Sub-Subject cards will be rendered here -->
                </div>
            </div>

            <!-- 2. Chapter Selection -->
            <div id="chapter-selection-area" class="mb-10">
                <h2 class="text-2xl font-bold text-cbse-blue mb-4 flex items-center"><i data-lucide="bookmark" class="h-6 w-6 mr-2"></i> Choose Chapter</h2>
                <div id="chapter-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Chapter cards will be rendered here -->
                    <div class="col-span-full text-gray-500 italic" id="chapter-placeholder">Select a stream above or check parameters.</div>
                </div>
            </div>

            <!-- 3. Difficulty Selection -->
            <div id="difficulty-selection-area" class="mt-12 p-6 bg-cbse-light rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-heading mb-4 flex items-center"><i data-lucide="flame" class="h-6 w-6 mr-2 text-accent-gold"></i> Select Difficulty</h2>
                <div id="difficulty-selection" class="flex flex-wrap justify-center md:justify-start gap-4">
                    <button class="difficulty-btn simple" data-difficulty="simple">Simple (Level 1)</button>
                    <button class="difficulty-btn medium" data-difficulty="medium">Medium (Level 2)</button>
                    <button class="difficulty-btn advance" data-difficulty="advance">Advance (Level 3)</button>
                </div>
                
                <p id="error-message" class="text-red-500 mt-4 text-center font-medium hidden">
                    Please select both a Chapter and a Difficulty level to start the quiz.
                </p>

                <div class="mt-8 text-center">
                    <button id="start-quiz-btn" class="px-10 py-4 bg-cbse-blue text-white rounded-xl font-extrabold text-xl opacity-50 cursor-not-allowed transition duration-300 shadow-lg" disabled>
                        Start Quiz
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER: Consistent Branding -->
    <footer class="bg-cbse-blue mt-16 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <p class="text-lg font-semibold mb-1">Ready4Exam</p>
            <small class="text-sm opacity-70 block">Â© 2025 Ready4Exam Academic Portal. All Rights Reserved. | A child of ready4industry.</small>
        </div>
    </footer>

    <!-- Script Imports -->
    <script type="module" src="./curriculum.js"></script>
    <script type="module">
        import curriculumData from './curriculum.js';
        
        // State variables
        let selectedTopic = null;
        let selectedDifficulty = null;
        let selectedSubSubject = null; // For subjects like Science, Social_Science
        
        // DOM Elements
        const chapterCardsEl = document.getElementById('chapter-cards');
        const chapterPlaceholderEl = document.getElementById('chapter-placeholder');
        const difficultySelectionEl = document.getElementById('difficulty-selection');
        const subSubjectSelectionEl = document.getElementById('sub-subject-selection');
        const subSubjectCardsEl = document.getElementById('sub-subject-cards');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const errorMessageEl = document.getElementById('error-message');
        const subjectNameEl = document.getElementById('subject-name');

        const CLASS_ID = '9'; // Focusing on class 9 for the pilot

        function updateStartButtonState() {
            const isReady = selectedTopic && selectedDifficulty;
            startQuizBtn.disabled = !isReady;
            startQuizBtn.classList.toggle('opacity-100', isReady);
            startQuizBtn.classList.toggle('opacity-50', !isReady);
            startQuizBtn.classList.toggle('cursor-not-allowed', !isReady);
            errorMessageEl.classList.add('hidden'); // Clear error on state change
        }

        function handleChapterSelection(topicId, topicTitle, clickedElement) {
            selectedTopic = topicId;

            // Remove 'selected' class from all chapter cards
            chapterCardsEl.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add 'selected' class to the clicked element
            clickedElement.classList.add('selected');
            
            updateStartButtonState();
        }

        function handleDifficultySelection(difficulty, clickedButton) {
            selectedDifficulty = difficulty;

            // Remove 'selected' class from all difficulty buttons
            difficultySelectionEl.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Add 'selected' class to the clicked button
            clickedButton.classList.add('selected');
            
            updateStartButtonState();
        }

        function handleSubSubjectSelection(subSubject, clickedElement) {
             selectedSubSubject = subSubject;

             // Remove 'selected' class from all sub-subject cards
             subSubjectCardsEl.querySelectorAll('.card').forEach(card => {
                 card.classList.remove('selected');
             });

             // Add 'selected' class to the clicked element
             clickedElement.classList.add('selected');

             // Render the chapters for the newly selected sub-subject
             renderChapters();
             
             // Reset chapter and difficulty selection
             selectedTopic = null;
             selectedDifficulty = null;
             chapterPlaceholderEl.classList.add('hidden');
             difficultySelectionEl.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
             updateStartButtonState();
        }


        function renderSubSubjectCards(subject, subSubjects) {
            subSubjectSelectionEl.classList.remove('hidden');
            subSubjectCardsEl.innerHTML = ''; // Clear previous content

            Object.keys(subSubjects).forEach(subSubjectKey => {
                // Determine icon based on sub-subject
                let iconName = 'book';
                if (subSubjectKey === 'Physics') iconName = 'atom';
                if (subSubjectKey === 'Chemistry') iconName = 'flask-conical';
                if (subSubjectKey === 'Biology') iconName = 'dna';

                const cardHtml = `
                    <div class="card cursor-pointer sub-subject-card border-2 border-transparent hover:border-cbse-blue" 
                         data-sub-subject="${subSubjectKey}">
                        <div class="flex items-center space-x-3 mb-2">
                            <i data-lucide="${iconName}" class="h-6 w-6 text-cbse-blue"></i>
                            <h3 class="text-xl font-extrabold text-heading">${subSubjectKey}</h3>
                        </div>
                        <p class="text-sm text-gray-500">Total chapters: ${subSubjects[subSubjectKey].length}</p>
                    </div>
                `;
                subSubjectCardsEl.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Attach event listeners to new sub-subject cards
            subSubjectCardsEl.querySelectorAll('.sub-subject-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    handleSubSubjectSelection(card.dataset.subSubject, card);
                });
            });

            lucide.createIcons(); // Re-render Lucide icons
        }

        function renderChapters() {
            const params = new URLSearchParams(window.location.search);
            const subject = params.get('subject');

            subjectNameEl.textContent = subject ? subject.replace(/_/g, ' ') : 'N/A';
            document.getElementById('main-title').textContent = `Class 9 - ${subjectNameEl.textContent} Quiz Drill`;


            const classData = curriculumData[CLASS_ID];
            if (!classData || !subject || !classData[subject]) {
                chapterCardsEl.innerHTML = `<p class="col-span-full text-red-500">Error: Curriculum data not found for Class ${CLASS_ID} / ${subject}.</p>`;
                return;
            }
            
            let chapters = [];
            let currentSubjectData = classData[subject];

            if (subject === 'Science' || subject === 'Social_Science') {
                // If it's a composite subject, we need to show sub-subjects first
                if (!selectedSubSubject) {
                    // If no sub-subject is selected, render the sub-subject cards
                    renderSubSubjectCards(subject, currentSubjectData);
                    // Hide chapter area until a sub-subject is selected
                    chapterCardsEl.innerHTML = `<p class="col-span-full text-gray-500 italic">Please select a stream (e.g., Physics) above to see the chapters.</p>`;
                    return; 
                }
                
                // If a sub-subject is selected, use its chapters
                chapters = currentSubjectData[selectedSubSubject] || [];
            } else {
                // For non-composite subjects (like Mathematics)
                chapters = currentSubjectData;
            }

            // At this point, sub-subject selection area might be hidden for non-composite subjects
            if (subject !== 'Science' && subject !== 'Social_Science') {
                subSubjectSelectionEl.classList.add('hidden');
            }


            chapterCardsEl.innerHTML = ''; // Clear previous content

            if (chapters.length === 0) {
                 chapterCardsEl.innerHTML = `<p class="col-span-full text-gray-500 italic">No chapters defined for ${subject} ${selectedSubSubject ? ' - ' + selectedSubSubject : ''}.</p>`;
                 return;
            }

            chapters.forEach(chapter => {
                const cardHtml = `
                    <div class="card cursor-pointer chapter-card border-2 border-transparent hover:border-cbse-blue" 
                         data-topic-id="${chapter.id}" data-topic-title="${chapter.title}">
                        <h3 class="text-lg font-bold text-cbse-blue">${chapter.title}</h3>
                        <p class="text-sm text-gray-500 mt-1">Ready for quiz drill.</p>
                        <i data-lucide="chevron-right" class="h-5 w-5 absolute top-5 right-5 text-gray-400"></i>
                    </div>
                `;
                chapterCardsEl.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Attach event listeners to new chapter cards
            chapterCardsEl.querySelectorAll('.chapter-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    handleChapterSelection(card.dataset.topicId, card.dataset.topicTitle, card);
                });
            });

            lucide.createIcons(); // Re-render Lucide icons
        }

        function handleStartQuiz() {
            if (selectedTopic && selectedDifficulty) {
                const params = new URLSearchParams(window.location.search);
                const subject = params.get('subject') || '';
                
                // Class and Subject are required
                if (!subject) {
                     errorMessageEl.textContent = 'A subject is required to start the quiz.';
                     errorMessageEl.classList.remove('hidden');
                     return;
                }

                // Pass the necessary parameters to the quiz engine
                let url = `quiz-engine.html?class=${CLASS_ID}&subject=${subject}&topic=${selectedTopic}&difficulty=${selectedDifficulty}`;
                
                // Only include sub_subject if it was selected (i.e., for Science/Social Science)
                if (selectedSubSubject) {
                    url += `&sub_subject=${selectedSubSubject}`;
                }
                
                // NOTE: Enforcing Motion topic for pilot, as per user request.
                if (selectedTopic !== 'motion') {
                    errorMessageEl.textContent = 'Pilot is restricted to the "Motion" chapter only. Please select Motion.';
                    errorMessageEl.classList.remove('hidden');
                    return;
                }
                
                window.location.href = url;
            } else {
                errorMessageEl.textContent = 'Please select both a Chapter and a Difficulty level to start the quiz.';
                errorMessageEl.classList.remove('hidden');
            }
        }

        // --- INITIALIZATION ---\n
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderChapters(); // Renders sub-subjects or chapters based on URL
            
            // Attach event listeners to difficulty buttons
            difficultySelectionEl.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const clickedButton = e.currentTarget; 
                    handleDifficultySelection(clickedButton.dataset.difficulty, clickedButton);
                });
            });

            startQuizBtn.addEventListener('click', handleStartQuiz);
            
            // Initial check for required parameters
            const params = new URLSearchParams(window.location.search);
            if (params.get('subject') === 'Science' && !selectedSubSubject) {
                // If on Science page, wait for sub-subject selection
                chapterPlaceholderEl.textContent = 'Please select a stream (Physics, Chemistry, or Biology) above.';
            }

        });
    </script>
</body>
</html>
