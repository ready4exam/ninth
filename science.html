<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBSE Class 9 — Science Topics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        'cbse-blue': '#1a3e6a', 
                        'cbse-light': '#f5f7fa',
                        'accent-gold': '#ffb703',
                        'heading': '#0f172a',
                    }
                }
            }
        }
    </script>
    <!-- Load Lucide icons library -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .card {
            @apply p-6 bg-white rounded-xl shadow-lg border border-gray-200 transition-all duration-300 cursor-pointer hover:shadow-xl hover:ring-2 hover:ring-cbse-blue/50;
        }
        .chapter-list li {
            @apply flex justify-between items-center py-4 px-6 mb-4 bg-gray-50 rounded-lg border border-gray-100 shadow-sm transition-colors duration-200;
        }
        .chapter-list li:hover {
            @apply bg-blue-50 border-blue-200;
        }
        .chapter-button {
            @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .quiz-option {
            @apply w-full p-4 mb-3 border border-gray-300 rounded-lg text-left transition-colors duration-200;
        }
        .quiz-option:hover {
            @apply bg-blue-50 border-blue-500;
        }
        .correct-answer {
            @apply bg-green-100 border-green-600;
        }
        .incorrect-answer {
            @apply bg-red-100 border-red-600;
        }
        .disabled-button {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-cbse-light min-h-screen antialiased font-sans">

    <!-- HEADER -->
    <header class="bg-white shadow-lg sticky top-0 z-10 border-t-8 border-cbse-blue">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-xl font-extrabold font-serif text-cbse-blue tracking-tight hover:text-accent-gold transition-colors">
                    &larr; Back to Subjects
                </a>
            </div>
            <h1 class="text-2xl font-bold text-heading">
                Class 9 Science Portal
            </h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
        
        <!-- --- TOPIC SELECTION VIEW (Physics, Chemistry, Biology) --- -->
        <div id="topic-selection-view">
            <h2 class="text-4xl font-extrabold font-serif text-heading mb-8 border-b-2 border-accent-gold pb-2">
                Step 1: Select a Science Topic
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <div class="card cursor-pointer" onclick="showChapterSelection('Physics', 'Motion, Force, & Gravitation')">
                    <i data-lucide="zap" class="text-yellow-500 h-8 w-8 mb-3"></i>
                    <h3 class="text-xl font-bold text-heading">Physics</h3>
                    <p class="text-sm text-gray-600 mt-2">Motion, Force & Laws of Motion, Gravitation, Work & Energy, Sound.</p>
                </div>

                <div class="card cursor-pointer" onclick="showChapterSelection('Chemistry', 'Atoms, Molecules, & Structure')">
                    <i data-lucide="beaker" class="text-green-500 h-8 w-8 mb-3"></i>
                    <h3 class="text-xl font-bold text-heading">Chemistry</h3>
                    <p class="text-sm text-gray-600 mt-2">Matter, Atoms and Molecules, Structure of the Atom.</p>
                </div>

                <div class="card cursor-pointer" onclick="showChapterSelection('Biology', 'Cell, Tissues, & Diversity')">
                    <i data-lucide="dna" class="text-red-500 h-8 w-8 mb-3"></i>
                    <h3 class="text-xl font-bold text-heading">Biology</h3>
                    <p class="text-sm text-gray-600 mt-2">Fundamental Unit of Life (Cell), Tissues, Diversity in Living Organisms.</p>
                </div>

            </div>
        </div>

        <!-- --- CHAPTER SELECTION VIEW --- -->
        <div id="chapter-selection-view" class="hidden mt-12">
            <h2 class="text-4xl font-extrabold font-serif text-heading mb-4">
                Step 2: <span id="current-topic-display" class="text-cbse-blue"></span>
            </h2>
            <p class="text-lg text-gray-700 mb-8 max-w-2xl" id="topic-description"></p>

            <ul id="chapter-list" class="chapter-list">
                <!-- Chapter items will be populated here -->
            </ul>

            <button onclick="goBackToTopics()" class="mt-6 chapter-button bg-gray-500 hover:bg-gray-600">
                &larr; Change Topic
            </button>
        </div>

        <!-- --- QUIZ VIEW --- -->
        <div id="quiz-view" class="hidden mt-12 max-w-3xl mx-auto">
            <h2 class="text-3xl font-extrabold font-serif text-cbse-blue mb-6 border-b pb-2">
                Quiz: <span id="quiz-chapter-title"></span>
            </h2>
            <div id="quiz-container">
                <!-- Quiz content will be loaded here -->
            </div>
            <div id="quiz-results" class="hidden mt-8 p-6 rounded-lg bg-green-50 border-2 border-green-300">
                <h3 class="text-2xl font-bold text-green-800 mb-2">Quiz Complete!</h3>
                <p class="text-lg text-green-700">You scored <span id="score-display" class="font-extrabold"></span> out of <span id="total-questions-display" class="font-extrabold"></span>.</p>
            </div>
            
            <button onclick="goBackToChapters()" class="mt-8 chapter-button bg-gray-500 hover:bg-gray-600">
                &larr; Back to Chapters
            </button>

            <!-- Error/Loading Message Box -->
            <div id="message-box" class="hidden mt-4 p-4 rounded-lg text-center font-semibold border-l-4" role="alert"></div>
        </div>

    </main>

    <!-- FOOTER WITH USER ID -->
    <footer class="bg-cbse-blue mt-16 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <small id="user-id-display" class="text-sm opacity-70 block">Initializing data service...</small>
            <small class="text-sm opacity-70 block mt-1">© 2025 Ready4Exam Academic Portal.</small>
        </div>
    </footer>

    <!-- 1. FIREBASE INITIALIZATION & EXPORTS (Self-contained module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Expose Firebase services globally for use by non-module scripts
        window.appId = appId; // Pass the appId for use in paths
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false; // CRITICAL: Readiness flag

        // Expose Firestore methods globally for the quiz logic
        window.getDoc = getDoc;
        window.doc = doc;
        window.setDoc = setDoc;

        async function initFirebaseAndAuth() {
            try {
                // 1. Initialize Firebase App and Services
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug'); 
                console.log("Firebase services initialized.");

                // 2. Set up Auth State Listener (onAuthStateChanged runs immediately)
                return new Promise((resolve) => {
                    onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.userId = user.uid;
                            console.log("User signed in with UID:", window.userId);
                        } else {
                            // Attempt sign-in if not signed in
                            try {
                                if (initialAuthToken) {
                                    const userCredential = await signInWithCustomToken(window.auth, initialAuthToken);
                                    window.userId = userCredential.user.uid;
                                    console.log("Signed in with custom token.");
                                } else {
                                    const userCredential = await signInAnonymously(window.auth);
                                    window.userId = userCredential.user.uid;
                                    console.log("Signed in anonymously. Using generated UID.");
                                }
                            } catch (error) {
                                console.error("Authentication failed:", error);
                                window.userId = crypto.randomUUID(); 
                            }
                        }

                        // 3. Mark Auth as Ready, Display User ID, and Resolve
                        window.isAuthReady = true;
                        console.log("Authentication complete. userId:", window.userId);
                        
                        const userIdElement = document.getElementById('user-id-display');
                        if (userIdElement && window.userId) {
                            userIdElement.textContent = `User ID: ${window.userId}`;
                        }
                        
                        resolve(true);
                    });
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                // No need to alert, just ensure isAuthReady is false
                window.isAuthReady = false;
                return false;
            }
        };

        // Call the initialization function immediately, but it runs asynchronously
        initFirebaseAndAuth();
    </script>

    <!-- 2. MAIN APPLICATION LOGIC (Must wait for Firebase globals) -->
    <script>
        // Data structure for the chapters (simplified for this app)
        const CHAPTER_DATA = {
            'Physics': [
                { id: 'physics_motion', title: 'Chapter 1: Motion', quizId: 'quiz_motion' },
                { id: 'physics_force', title: 'Chapter 2: Force & Laws of Motion', quizId: 'quiz_force' },
                { id: 'physics_gravitation', title: 'Chapter 3: Gravitation', quizId: 'quiz_gravitation' }
            ],
            'Chemistry': [
                { id: 'chemistry_matter', title: 'Chapter 4: Matter in Our Surroundings', quizId: 'quiz_matter' },
                { id: 'chemistry_atoms', title: 'Chapter 5: Atoms and Molecules', quizId: 'quiz_atoms' }
            ],
            'Biology': [
                { id: 'biology_cell', title: 'Chapter 6: The Fundamental Unit of Life (Cell)', quizId: 'quiz_cell' },
                { id: 'biology_tissues', title: 'Chapter 7: Tissues', quizId: 'quiz_tissues' }
            ]
        };

        // Current state
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedTopic = '';

        // --- UI Navigation Handlers ---

        function showView(viewId) {
            document.getElementById('topic-selection-view').classList.add('hidden');
            document.getElementById('chapter-selection-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function goBackToTopics() {
            showView('topic-selection-view');
        }

        function goBackToChapters() {
            // Hide quiz, reset state, and show chapter view
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-container').innerHTML = ''; // Clear quiz content
            currentQuizData = [];
            currentQuestionIndex = 0;
            score = 0;
            showView('chapter-selection-view');
            hideMessageBox();
        }
        
        function showMessageBox(message, type = 'error') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'border-red-400', 'bg-red-100', 'text-red-800', 'border-green-400', 'bg-green-100', 'text-green-800');

            if (type === 'error') {
                box.classList.add('border-red-400', 'bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                box.classList.add('border-green-400', 'bg-green-100', 'text-green-800');
            }
        }

        function hideMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
        }


        // --- Chapter Selection Logic ---

        function showChapterSelection(topicName, description) {
            selectedTopic = topicName;
            document.getElementById('current-topic-display').textContent = topicName;
            document.getElementById('topic-description').textContent = 'Key concepts include: ' + description + '.';

            const chapterListEl = document.getElementById('chapter-list');
            chapterListEl.innerHTML = '';
            
            const chapters = CHAPTER_DATA[topicName] || [];
            
            chapters.forEach(chapter => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="text-lg font-medium text-gray-800">${chapter.title}</span>
                    <button class="chapter-button" onclick="loadQuizData('${chapter.quizId}')">
                        Start Quiz 
                        <i data-lucide="play-circle" class="h-4 w-4 ml-2"></i>
                    </button>
                `;
                chapterListEl.appendChild(li);
            });

            // Re-render icons for new elements
            lucide.createIcons();
            showView('chapter-selection-view');
        }

        // --- QUIZ DATA and RENDER LOGIC ---

        async function loadQuizData(chapterId) {
            showView('quiz-view');
            hideMessageBox();
            document.getElementById('quiz-container').innerHTML = '<div class="text-center py-12"><i data-lucide="loader-circle" class="animate-spin text-blue-500 h-10 w-10 mx-auto mb-4"></i><p class="text-gray-600 font-semibold">Loading quiz data...</p></div>';
            lucide.createIcons();
            
            // CRITICAL CHECK: Wait for Firebase and Auth to be ready
            if (typeof window.db === 'undefined' || !window.isAuthReady) {
                console.error("Data service not ready. Firestore DB or Auth is not initialized.");
                showMessageBox("Failed to load quiz content. (Data service not ready. Please wait for 'Initializing data service...' to change to a User ID and try again.)", 'error');
                return;
            }
            
            // Retrieve global variables set by the module script
            const db = window.db;
            const appId = window.appId;
            const getDoc = window.getDoc;
            const doc = window.doc;
            const setDoc = window.setDoc; // Needed for saving generated quiz
            
            try {
                // Construct the Firestore path: /artifacts/{appId}/public/data/quizzes/{quizId}
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, chapterId);
                const docSnap = await getDoc(quizRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.questionsJson) {
                         currentQuizData = JSON.parse(data.questionsJson); // Assuming questions are stored as a JSON string
                    } else if (data.questions && Array.isArray(data.questions)) {
                         currentQuizData = data.questions; 
                    } else {
                         throw new Error("Quiz document found but contains no valid questions.");
                    }

                    
                    if (currentQuizData.length > 0) {
                        const chapterInfo = Object.values(CHAPTER_DATA).flat().find(c => c.quizId === chapterId);
                        document.getElementById('quiz-chapter-title').textContent = chapterInfo ? chapterInfo.title : 'Quiz';
                        currentQuestionIndex = 0;
                        score = 0;
                        renderQuestion();
                    } else {
                        showMessageBox("The quiz is empty or improperly formatted. Generating content...", 'success');
                        await generateAndSaveQuiz(chapterId);
                    }
                } else {
                    // Quiz data not found, so we must generate it and save it first.
                    showMessageBox(`Quiz data for '${chapterId}' not found. Generating content...`, 'success');
                    await generateAndSaveQuiz(chapterId);
                }
            } catch (error) {
                console.error("Error loading or generating quiz data:", error);
                showMessageBox("Failed to load quiz content. Please try refreshing or check your internet connection.", 'error');
            }
        }

        async function generateAndSaveQuiz(chapterId) {
            document.getElementById('quiz-container').innerHTML = '<div class="text-center py-12"><i data-lucide="dices" class="animate-pulse text-accent-gold h-10 w-10 mx-auto mb-4"></i><p class="text-gray-600 font-semibold">Generating 5 practice questions for you...</p></div>';
            lucide.createIcons();
            
            const userQuery = `Generate 5 multiple-choice questions for the CBSE Class 9 chapter titled: ${chapterId.replace('_', ' ').toUpperCase().split(' ').slice(1).join(' ')}. Each question must have 4 options and one correct answer, and must be formatted as a JSON array.`;
            
            const systemPrompt = "You are an expert CBSE curriculum quiz generator. You must respond ONLY with a single JSON array object that adheres to the provided schema. Do not include any introductory or concluding text. The questions should be engaging and accurately reflect the learning material.";
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING", "description": "The question text." },
                                "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "An array of four possible answers." },
                                "correctAnswerIndex": { "type": "INTEGER", "description": "The 0-based index of the correct answer in the options array." }
                            },
                            "required": ["question", "options", "correctAnswerIndex"]
                        }
                    }
                }
            };
            
            let generatedJsonText;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                generatedJsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!generatedJsonText) {
                     throw new Error("API returned no content.");
                }

                // 1. Parse and validate
                const generatedQuiz = JSON.parse(generatedJsonText);
                currentQuizData = generatedQuiz;

                // 2. Save the generated quiz to Firestore
                const db = window.db;
                const appId = window.appId;
                const setDoc = window.setDoc;
                const doc = window.doc;

                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, chapterId);
                await setDoc(quizRef, {
                    quizId: chapterId,
                    createdAt: new Date().toISOString(),
                    questionsJson: JSON.stringify(generatedQuiz)
                });
                
                // 3. Start the quiz
                const chapterInfo = Object.values(CHAPTER_DATA).flat().find(c => c.quizId === chapterId);
                document.getElementById('quiz-chapter-title').textContent = chapterInfo ? chapterInfo.title : 'Quiz';
                currentQuestionIndex = 0;
                score = 0;
                hideMessageBox();
                renderQuestion();

            } catch (error) {
                console.error("Error generating or saving quiz:", error, generatedJsonText);
                showMessageBox(`Error processing content: ${error.message}. Please try a different chapter.`, 'error');
            }
        }
        
        // --- QUIZ RENDERING AND INTERACTION ---

        function renderQuestion() {
            document.getElementById('quiz-results').classList.add('hidden');
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            
            if (currentQuestionIndex >= currentQuizData.length) {
                showResults();
                return;
            }

            const questionData = currentQuizData[currentQuestionIndex];
            
            let optionsHtml = questionData.options.map((option, index) => `
                <button class="quiz-option text-lg" data-index="${index}" onclick="checkAnswer(this, ${index}, ${questionData.correctAnswerIndex})">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <p class="text-xl font-semibold text-heading mb-4">Question ${currentQuestionIndex + 1} of ${currentQuizData.length}</p>
                    <p class="text-2xl font-serif text-gray-800 mb-8">${questionData.question}</p>
                    <div id="options-container" class="space-y-3">
                        ${optionsHtml}
                    </div>
                    <button id="next-button" class="mt-6 chapter-button disabled-button" onclick="nextQuestion()">
                        Next Question &rarr;
                    </button>
                </div>
            `;
        }
        
        function checkAnswer(selectedButton, selectedIndex, correctIndex) {
            const optionsContainer = document.getElementById('options-container');
            const options = optionsContainer.querySelectorAll('.quiz-option');
            
            // Disable all options after selection
            options.forEach(button => {
                button.disabled = true;
                button.classList.remove('hover:bg-blue-50', 'hover:border-blue-500');
                
                // Highlight correct and incorrect
                const index = parseInt(button.dataset.index);
                if (index === correctIndex) {
                    button.classList.add('correct-answer');
                } else if (index === selectedIndex) {
                    button.classList.add('incorrect-answer');
                }
            });

            // Update score
            if (selectedIndex === correctIndex) {
                score++;
            }
            
            // Enable next button
            document.getElementById('next-button').classList.remove('disabled-button');
        }

        function nextQuestion() {
            document.getElementById('next-button').classList.add('disabled-button');
            currentQuestionIndex++;
            renderQuestion();
        }

        function showResults() {
            document.getElementById('quiz-container').innerHTML = '';
            document.getElementById('score-display').textContent = score;
            document.getElementById('total-questions-display').textContent = currentQuizData.length;
            document.getElementById('quiz-results').classList.remove('hidden');
            
            // Determine if user passed (e.g., 60%)
            const passThreshold = currentQuizData.length * 0.6;
            const resultsBox = document.getElementById('quiz-results');

            if (score >= passThreshold) {
                resultsBox.classList.remove('bg-red-50', 'border-red-300');
                resultsBox.classList.add('bg-green-50', 'border-green-300');
                resultsBox.querySelector('h3').textContent = "Excellent Work!";
            } else {
                resultsBox.classList.remove('bg-green-50', 'border-green-300');
                resultsBox.classList.add('bg-red-50', 'border-red-300');
                resultsBox.querySelector('h3').textContent = "Good Attempt! Review Needed.";
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Start on the topic selection view
            showView('topic-selection-view'); 
        });

    </script>
</body>
</html>
