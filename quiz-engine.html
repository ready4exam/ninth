<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Loading Quiz...</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Tailwind Configuration (Matching the science.html design)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        'cbse-blue': '#1a3e6a', 
                        'cbse-light': '#f0f4f8', 
                        'heading': '#0f172a',
                        'accent-success': '#059669', // Emerald
                        'accent-danger': '#ef4444',   // Red
                        'accent-info': '#3b82f6',     // Blue
                    }
                }
            }
        }
    </script>
    <style>
        .option-button {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: left;
            white-space: normal;
        }
        .option-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .correct {
            background-color: var(--accent-success); 
            color: white;
            border-color: var(--accent-success);
        }
        .incorrect {
            background-color: var(--accent-danger); 
            color: white;
            border-color: var(--accent-danger);
        }
        .selected {
            border: 3px solid var(--accent-info);
            transform: scale(1.01);
        }
        .pulse-loader {
            display: inline-block;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-cbse-light min-h-screen antialiased font-sans">

    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-10 border-t-8 border-cbse-blue">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="science.html" class="flex items-center space-x-3 cursor-pointer">
                <i data-lucide="flask-round" class="text-cbse-blue h-7 w-7"></i>
                <h1 class="text-2xl font-extrabold font-serif text-cbse-blue tracking-tight">
                    Quiz Engine
                </h1>
            </a>
            <nav>
                <a href="science.html" class="px-3 py-1 rounded-lg text-gray-700 hover:bg-cbse-light hover:text-cbse-blue transition">Back to Chapters</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
        <h2 class="text-3xl font-extrabold font-serif text-heading mb-4 text-center">
            <span id="quiz-topic-title"></span> Quiz
        </h2>
        <div class="text-center text-gray-600 mb-8">
            <span id="quiz-progress-display"></span>
        </div>

        <!-- 1. Loading/Error View -->
        <div id="loading-view" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <i data-lucide="loader" class="h-10 w-10 text-cbse-blue mx-auto mb-4 animate-spin"></i>
            <p id="loading-message" class="text-lg font-semibold text-cbse-blue">Initializing Services and Fetching Questions...</p>
        </div>

        <!-- 2. Quiz View -->
        <div id="quiz-view" class="hidden">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-t-4 border-accent-info">
                <!-- Question Text -->
                <p id="question-text" class="text-xl font-serif text-heading mb-6 min-h-[50px]"></p>
                
                <!-- Options -->
                <div id="options-container" class="space-y-4">
                    <!-- Option buttons generated here -->
                </div>

                <!-- Navigation -->
                <div class="mt-8 flex justify-between">
                    <button id="prev-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition" disabled>
                        <i data-lucide="arrow-left" class="w-5 h-5 inline-block mr-1"></i> Previous
                    </button>
                    <button id="next-btn" class="px-6 py-3 bg-cbse-blue text-white font-semibold rounded-lg hover:bg-accent-info transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Next <i data-lucide="arrow-right" class="w-5 h-5 inline-block ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. Results View -->
        <div id="results-view" class="hidden bg-white p-8 rounded-xl shadow-lg text-center">
            <i data-lucide="award" class="h-12 w-12 text-accent-success mx-auto mb-4"></i>
            <h3 class="text-3xl font-extrabold font-serif text-heading mb-4">Quiz Complete!</h3>
            <p class="text-2xl mb-6">Your Score: <span id="final-score" class="font-bold text-accent-success"></span></p>
            
            <p id="results-message" class="text-gray-700 mb-6"></p>

            <button onclick="window.location.href='science.html'" class="px-8 py-3 bg-cbse-blue text-white font-semibold rounded-lg hover:bg-accent-info transition shadow-lg">
                <i data-lucide="redo" class="w-5 h-5 inline-block mr-2"></i> Go Back to Chapters
            </button>
        </div>

        <!-- Custom Modal for Errors/Messages -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h4 id="modal-title" class="text-xl font-bold text-accent-danger mb-3">Error</h4>
                <p id="modal-content" class="text-gray-700 mb-4">An unexpected error occurred.</p>
                <button onclick="document.getElementById('custom-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg text-gray-800 hover:bg-gray-300 transition">Close</button>
            </div>
        </div>
    </main>

    <!-- Footer (Matching the science.html design) -->
    <footer class="bg-cbse-blue mt-16 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white">
            <small class="text-sm opacity-70 block">Â© 2025 CBSE Class 9 Academic Portal. Dedicated to Student Success.</small>
        </div>
    </footer>

    <script type="module">
        // --- GLOBAL VARIABLES & SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db;
        let auth;
        let supabase;
        let userId = 'anonymous'; 
        
        let quizData = [];
        let userAnswers = [];
        let currentQuestionIndex = 0;
        let topicSlug = '';
        let quizTitle = '';

        // --- DOM Elements ---
        const pageTitle = document.getElementById('page-title');
        const loadingView = document.getElementById('loading-view');
        const loadingMessage = document.getElementById('loading-message');
        const quizView = document.getElementById('quiz-view');
        const resultsView = document.getElementById('results-view');
        const quizTopicTitle = document.getElementById('quiz-topic-title');
        const quizProgressDisplay = document.getElementById('quiz-progress-display');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finalScore = document.getElementById('final-score');
        const resultsMessage = document.getElementById('results-message');
        const modal = document.getElementById('custom-modal');

        // --- UTILITY FUNCTIONS ---
        function showModal(title, content, isError = true) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('modal-title').classList.toggle('text-accent-danger', isError);
            document.getElementById('modal-title').classList.toggle('text-accent-info', !isError);
            modal.classList.remove('hidden');
        }

        function showView(view) {
            loadingView.classList.add('hidden');
            quizView.classList.add('hidden');
            resultsView.classList.add('hidden');
            if (view === 'loading') loadingView.classList.remove('hidden');
            else if (view === 'quiz') quizView.classList.remove('hidden');
            else if (view === 'results') resultsView.classList.remove('hidden');
        }

        // --- HYBRID SERVICE INITIALIZATION ---
        async function initHybridServices() {
            setLogLevel('Debug');
            
            // 1. Parse URL for topic slug
            const params = new URLSearchParams(window.location.search);
            topicSlug = params.get('topic');
            
            if (!topicSlug) {
                loadingMessage.textContent = "Error: Topic is missing from the URL.";
                return false;
            }

            // 2. Initialize Supabase (Question Data)
            try {
                const supabaseUrl = typeof __supabase_url !== 'undefined' ? __supabase_url : null;
                const supabaseAnonKey = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : null;
                
                if (!supabaseUrl || !supabaseAnonKey) {
                    throw new Error("Supabase URL or Key is missing. Check global variables.");
                }
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                console.log("Supabase initialized.");
            } catch (error) {
                loadingMessage.textContent = `Supabase Error: ${error.message}`;
                return false;
            }

            // 3. Initialize Firebase (Auth & Results)
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
                    throw new Error("Firebase config is missing.");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle authentication 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Firebase: Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase: Signed in anonymously.");
                }

                userId = auth.currentUser?.uid || 'anonymous';
                console.log("Firebase initialized. Current user ID:", userId);

            } catch (error) {
                loadingMessage.textContent = `Firebase Auth Error: ${error.message}`;
                return false;
            }
            return true;
        }

        // --- DATA FETCHING (SUPABASE) ---

        /**
         * Fetches quiz data from the Supabase 'quizzes' table.
         * Assumes table has columns: topic_slug, title, questions (JSON array)
         */
        async function loadQuizData() {
            loadingMessage.textContent = `Fetching quiz for topic: ${topicSlug}...`;
            try {
                // NOTE: Using a generic 'quizzes' table name. Change this if your table is named differently.
                const { data, error } = await supabase
                    .from('quizzes')
                    .select('title, questions') // Assuming 'questions' is a JSON/Array column
                    .eq('topic_slug', topicSlug)
                    .single();

                if (error || !data) {
                    throw new Error(`Data Fetch Error: ${error ? error.message : 'No data found.'}`);
                }

                quizTitle = data.title || topicSlug.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                quizData = data.questions;

                if (!quizData || quizData.length === 0) {
                     throw new Error("No questions found for this topic.");
                }

                // Initialize user answers array
                userAnswers = new Array(quizData.length).fill(null);
                
                return true;

            } catch (error) {
                console.error("Quiz loading failed:", error);
                loadingMessage.textContent = `Failed to load quiz: ${error.message}. Please check Supabase table name and data structure.`;
                return false;
            }
        }

        // --- QUIZ LOGIC ---

        function updateProgress() {
            quizProgressDisplay.textContent = `Question ${currentQuestionIndex + 1} of ${quizData.length}`;
            quizTopicTitle.textContent = quizTitle;
            pageTitle.textContent = `${quizTitle} Quiz`;
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.textContent = (currentQuestionIndex === quizData.length - 1) ? 'Submit Quiz' : 'Next';
            lucide.createIcons();
        }
        
        function renderQuestion() {
            const q = quizData[currentQuestionIndex];
            if (!q) return;

            questionText.innerHTML = `${currentQuestionIndex + 1}. ${q.text}`;
            optionsContainer.innerHTML = '';
            
            q.options.forEach((optionText, index) => {
                const btn = document.createElement('button');
                btn.className = `option-button w-full px-4 py-3 rounded-lg bg-white text-gray-800 border-2 border-gray-200 hover:bg-gray-50 transition`;
                btn.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65 + index)}.</span> ${optionText}`;
                btn.dataset.index = index;
                
                // Highlight if already answered
                if (userAnswers[currentQuestionIndex] === index) {
                    btn.classList.add('selected');
                }

                // Attach click handler
                btn.addEventListener('click', () => handleOptionClick(btn, index));
                optionsContainer.appendChild(btn);
            });
            
            updateProgress();
        }

        function handleOptionClick(selectedBtn, selectedIndex) {
            // Remove selection from all buttons for the current question
            optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Apply selection to the clicked button
            selectedBtn.classList.add('selected');
            
            // Record the answer
            userAnswers[currentQuestionIndex] = selectedIndex;
        }

        function navigate(direction) {
            if (userAnswers[currentQuestionIndex] === null) {
                showModal("Wait!", "Please select an answer before moving to the next question.", false);
                return;
            }

            if (direction === 'next') {
                if (currentQuestionIndex < quizData.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion();
                } else {
                    submitQuiz();
                }
            } else if (direction === 'prev' && currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function calculateScore() {
            let score = 0;
            quizData.forEach((q, index) => {
                if (userAnswers[index] === q.correct_answer_index) {
                    score++;
                }
            });
            return score;
        }

        async function submitQuiz() {
            showView('loading');
            loadingMessage.textContent = "Calculating score and submitting results to Firestore...";

            const score = calculateScore();
            const total = quizData.length;
            const percentage = (score / total) * 100;
            
            // 1. Submit results to Firestore (Private Collection)
            try {
                const resultsCollectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/quiz_results`;
                
                await addDoc(collection(db, resultsCollectionPath), {
                    topic_slug: topicSlug,
                    title: quizTitle,
                    score: score,
                    total_questions: total,
                    timestamp: serverTimestamp(),
                    user_id: userId,
                });
                console.log("Results successfully written to Firestore.");
            } catch (error) {
                console.error("Error writing results to Firestore:", error);
                // Continue to display results even if saving fails
            }

            // 2. Display Results
            finalScore.textContent = `${score} / ${total} (${percentage.toFixed(0)}%)`;

            if (percentage >= 80) {
                resultsMessage.textContent = "Excellent work! You've mastered this topic. Keep up the great studying!";
                finalScore.classList.add('text-accent-success');
                finalScore.classList.remove('text-accent-danger');
            } else if (percentage >= 50) {
                resultsMessage.textContent = "Good effort! Review the topics you struggled with for better results next time.";
                finalScore.classList.remove('text-accent-success', 'text-accent-danger');
                finalScore.classList.add('text-accent-info');
            } else {
                resultsMessage.textContent = "Time for a dedicated study session! Don't worry, you can re-take the quiz anytime.";
                finalScore.classList.add('text-accent-danger');
                finalScore.classList.remove('text-accent-success');
            }

            showView('results');
        }

        // --- EVENT LISTENERS ---
        nextBtn.addEventListener('click', () => navigate('next'));
        prevBtn.addEventListener('click', () => navigate('prev'));

        // --- MAIN ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            const servicesReady = await initHybridServices();
            
            if (servicesReady) {
                const dataLoaded = await loadQuizData();
                if (dataLoaded) {
                    currentQuestionIndex = 0;
                    renderQuestion();
                    showView('quiz');
                }
            }
        });
        
    </script>
</body>
</html>
